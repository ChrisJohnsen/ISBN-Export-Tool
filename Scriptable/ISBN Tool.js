/*! production git: v0.3-0-g05b5122 */
function e(e){return!!e&&"object"==typeof e}const t=FileManager.local();function n(e){return t.fileName(e)}function i(e,n,i){const s=function(e){const n=t.fileName(e,!0);if(!e.endsWith(n))throw"path does not end with extracted filename!?";return e.slice(0,e.length-n.length).replace(/[/]*$/,"")}(e),r=t.fileName(e),a=i?.(r)??r;return t.joinPath(s,a+"."+n)}class s{rw;constructor(e){this.rw=new a(e)}data;async read(){await this.rw.exists()?this.data=JSON.parse(await this.rw.readString()):this.data=null}async write(){this.rw.writeString(JSON.stringify(this.data))}}class r{rw;constructor(e){this.rw=new a(e)}log=[];append(e){this.log.push(e)}async flush(){if(this.log.length>0){const e=this.log.splice(0);await this.rw.writeString(await this.rw.readString()+e.join("\n")+"\n")}}}class a{constructor(e){this._pathname=e}get pathname(){return this._pathname}async exists(){return t.fileExists(this._pathname)}async read(){return t.fileExists(this._pathname)?(await t.downloadFileFromiCloud(this._pathname),t.read(this._pathname)):Data.fromString("")}async write(e){t.write(this._pathname,e)}async readString(){return(await this.read()).toRawString()}async writeString(e){return this.write(Data.fromString(e))}async remove(){return t.remove(this._pathname)}}function o(){}function c(){return"undefined"!=typeof WeakMap?new WeakMap:{add:o,delete:o,get:o,set:o,has:function(e){return!1}}}var l=Object.prototype.hasOwnProperty,d=function(e,t){return l.call(e,t)};function u(e,t){for(var n in t)d(t,n)&&(e[n]=t[n]);return e}var h=/^[ \t]*(?:\r\n|\r|\n)/,p=/(?:\r\n|\r|\n)[ \t]*$/,f=/^(?:[\r\n]|$)/,g=/(?:\r\n|\r|\n)([ \t]*)(?:[^ \t\r\n]|$)/,m=/^[ \t]*[\r\n][ \t\r\n]*$/;function w(e,t,n){var i=0,s=e[0].match(g);s&&(i=s[1].length);var r=new RegExp("(\\r\\n|\\r|\\n).{0,"+i+"}","g");t&&(e=e.slice(1));var a=n.newline,o=n.trimLeadingNewline,c=n.trimTrailingNewline,l="string"==typeof a,d=e.length;return e.map((function(e,t){return e=e.replace(r,"$1"),0===t&&o&&(e=e.replace(h,"")),t===d-1&&c&&(e=e.replace(p,"")),l&&(e=e.replace(/\r\n|\n|\r/g,(function(e){return a}))),e}))}function b(e,t){for(var n="",i=0,s=e.length;i<s;i++)n+=e[i],i<s-1&&(n+=t[i]);return n}function y(e){return d(e,"raw")&&d(e,"length")}var v=function e(t){var n=c(),i=c(),s=u((function s(r){for(var a=[],o=1;o<arguments.length;o++)a[o-1]=arguments[o];if(y(r)){var c=r,l=(a[0]===s||a[0]===v)&&m.test(c[0])&&f.test(c[1]),d=l?i:n,h=d.get(c);if(h||(h=w(c,l,t),d.set(c,h)),0===a.length)return h[0];var p=b(h,l?a.slice(1):a);return p}return e(u(u({},t),r||{}))}),{string:function(e){return w([e],!1,t)[0]}});return s}({trimLeadingNewline:!0,trimTrailingNewline:!0});if("undefined"!=typeof module)try{module.exports=v,Object.defineProperty(v,"__esModule",{value:!0}),v.default=v,v.outdent=v}catch(e){}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function S(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){if(this instanceof e){var n=[null];n.push.apply(n,arguments);var i=Function.bind.apply(t,n);return new i}return t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})})),n}var I={},R={get exports(){return I},set exports(e){I=e}},E=S(Object.freeze({__proto__:null,default:{}}));R.exports=function e(){var t="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==t?t:{};function n(){var n=t.URL||t.webkitURL||null,i=e.toString();return o.BLOB_URL||(o.BLOB_URL=n.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",i,")();"],{type:"text/javascript"})))}var i=!t.document&&!!t.postMessage,s=t.IS_PAPA_WORKER||!1,r={},a=0,o={};if(o.parse=l,o.unparse=d,o.RECORD_SEP=String.fromCharCode(30),o.UNIT_SEP=String.fromCharCode(31),o.BYTE_ORDER_MARK="\ufeff",o.BAD_DELIMITERS=["\r","\n",'"',o.BYTE_ORDER_MARK],o.WORKERS_SUPPORTED=!i&&!!t.Worker,o.NODE_STREAM_INPUT=1,o.LocalChunkSize=10485760,o.RemoteChunkSize=5242880,o.DefaultDelimiter=",",o.Parser=y,o.ParserHandle=w,o.NetworkStreamer=h,o.FileStreamer=p,o.StringStreamer=f,o.ReadableStreamStreamer=g,"undefined"==typeof PAPA_BROWSER_CONTEXT&&(o.DuplexStreamStreamer=m),t.jQuery){var c=t.jQuery;c.fn.parse=function(e){var n=e.config||{},i=[];return this.each((function(e){if("INPUT"!==c(this).prop("tagName").toUpperCase()||"file"!==c(this).attr("type").toLowerCase()||!t.FileReader||!this.files||0===this.files.length)return!0;for(var s=0;s<this.files.length;s++)i.push({file:this.files[s],inputElem:this,instanceConfig:c.extend({},n)})})),s(),this;function s(){if(0!==i.length){var t=i[0];if(N(e.before)){var n=e.before(t.file,t.inputElem);if("object"==typeof n){if("abort"===n.action)return void r("AbortError",t.file,t.inputElem,n.reason);if("skip"===n.action)return void a();"object"==typeof n.config&&(t.instanceConfig=c.extend(t.instanceConfig,n.config))}else if("skip"===n)return void a()}var s=t.instanceConfig.complete;t.instanceConfig.complete=function(e){N(s)&&s(e,t.file,t.inputElem),a()},o.parse(t.file,t.instanceConfig)}else N(e.complete)&&e.complete()}function r(t,n,i,s){N(e.error)&&e.error({name:t},n,i,s)}function a(){i.splice(0,1),s()}}}function l(e,n){var i=(n=n||{}).dynamicTyping||!1;if(N(i)&&(n.dynamicTypingFunction=i,i={}),n.dynamicTyping=i,n.transform=!!N(n.transform)&&n.transform,n.worker&&o.WORKERS_SUPPORTED){var s=v();return s.userStep=n.step,s.userChunk=n.chunk,s.userComplete=n.complete,s.userError=n.error,n.step=N(n.step),n.chunk=N(n.chunk),n.complete=N(n.complete),n.error=N(n.error),delete n.worker,void s.postMessage({input:e,config:n,workerId:s.id})}var r=null;return e===o.NODE_STREAM_INPUT&&"undefined"==typeof PAPA_BROWSER_CONTEXT?(r=new m(n)).getStream():("string"==typeof e?(e=a(e),r=n.download?new h(n):new f(n)):!0===e.readable&&N(e.read)&&N(e.on)?r=new g(n):(t.File&&e instanceof File||e instanceof Object)&&(r=new p(n)),r.stream(e));function a(e){return 65279===e.charCodeAt(0)?e.slice(1):e}}function d(e,t){var n=!1,i=!0,s=",",r="\r\n",a='"',c=a+a,l=!1,d=null,u=!1;p();var h=new RegExp(b(a),"g");if("string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return f(null,e,l);if("object"==typeof e[0])return f(d||Object.keys(e[0]),e,l)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields||d),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:"object"==typeof e.data[0]?Object.keys(e.data[0]):[]),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),f(e.fields||[],e.data||[],l);throw new Error("Unable to serialize unrecognized input");function p(){if("object"==typeof t){if("string"!=typeof t.delimiter||o.BAD_DELIMITERS.filter((function(e){return-1!==t.delimiter.indexOf(e)})).length||(s=t.delimiter),("boolean"==typeof t.quotes||"function"==typeof t.quotes||Array.isArray(t.quotes))&&(n=t.quotes),"boolean"!=typeof t.skipEmptyLines&&"string"!=typeof t.skipEmptyLines||(l=t.skipEmptyLines),"string"==typeof t.newline&&(r=t.newline),"string"==typeof t.quoteChar&&(a=t.quoteChar),"boolean"==typeof t.header&&(i=t.header),Array.isArray(t.columns)){if(0===t.columns.length)throw new Error("Option columns is empty");d=t.columns}void 0!==t.escapeChar&&(c=t.escapeChar+a),("boolean"==typeof t.escapeFormulae||t.escapeFormulae instanceof RegExp)&&(u=t.escapeFormulae instanceof RegExp?t.escapeFormulae:/^[=+\-@\t\r].*$/)}}function f(e,t,n){var a="";"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t));var o=Array.isArray(e)&&e.length>0,c=!Array.isArray(t[0]);if(o&&i){for(var l=0;l<e.length;l++)l>0&&(a+=s),a+=g(e[l],l);t.length>0&&(a+=r)}for(var d=0;d<t.length;d++){var u=o?e.length:t[d].length,h=!1,p=o?0===Object.keys(t[d]).length:0===t[d].length;if(n&&!o&&(h="greedy"===n?""===t[d].join("").trim():1===t[d].length&&0===t[d][0].length),"greedy"===n&&o){for(var f=[],m=0;m<u;m++){var w=c?e[m]:m;f.push(t[d][w])}h=""===f.join("").trim()}if(!h){for(var b=0;b<u;b++){b>0&&!p&&(a+=s);var y=o&&c?e[b]:b;a+=g(t[d][y],b)}d<t.length-1&&(!n||u>0&&!p)&&(a+=r)}}return a}function g(e,t){if(null==e)return"";if(e.constructor===Date)return JSON.stringify(e).slice(1,25);var i=!1;u&&"string"==typeof e&&u.test(e)&&(e="'"+e,i=!0);var r=e.toString().replace(h,c);return(i=i||!0===n||"function"==typeof n&&n(e,t)||Array.isArray(n)&&n[t]||m(r,o.BAD_DELIMITERS)||r.indexOf(s)>-1||" "===r.charAt(0)||" "===r.charAt(r.length-1))?a+r+a:r}function m(e,t){for(var n=0;n<t.length;n++)if(e.indexOf(t[n])>-1)return!0;return!1}}function u(e){function n(e){var t=k(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new w(t),this._handle.streamer=this,this._config=t}this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},n.call(this,e),this.parseChunk=function(e,n){if(this.isFirstChunk&&N(this._config.beforeFirstChunk)){var i=this._config.beforeFirstChunk(e);void 0!==i&&(e=i)}this.isFirstChunk=!1,this._halted=!1;var r=this._partialLine+e;this._partialLine="";var a=this._handle.parse(r,this._baseIndex,!this._finished);if(!this._handle.paused()&&!this._handle.aborted()){var c=a.meta.cursor;this._finished||(this._partialLine=r.substring(c-this._baseIndex),this._baseIndex=c),a&&a.data&&(this._rowCount+=a.data.length);var l=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(s)t.postMessage({results:a,workerId:o.WORKER_ID,finished:l});else if(N(this._config.chunk)&&!n){if(this._config.chunk(a,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);a=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(a.data),this._completeResults.errors=this._completeResults.errors.concat(a.errors),this._completeResults.meta=a.meta),this._completed||!l||!N(this._config.complete)||a&&a.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),l||a&&a.meta.paused||this._nextChunk(),a}this._halted=!0},this._sendError=function(e){N(this._config.error)?this._config.error(e):s&&this._config.error&&t.postMessage({workerId:o.WORKER_ID,error:e,finished:!1})}}function h(e){var t;function n(e){var t=e.getResponseHeader("Content-Range");return null===t?-1:parseInt(t.substring(t.lastIndexOf("/")+1))}(e=e||{}).chunkSize||(e.chunkSize=o.RemoteChunkSize),u.call(this,e),this._nextChunk=i?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),i||(t.onload=O(this._chunkLoaded,this),t.onerror=O(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!i),this._config.downloadRequestHeaders){var e=this._config.downloadRequestHeaders;for(var n in e)t.setRequestHeader(n,e[n])}if(this._config.chunkSize){var s=this._start+this._config.chunkSize-1;t.setRequestHeader("Range","bytes="+this._start+"-"+s)}try{t.send(this._config.downloadRequestBody)}catch(e){this._chunkError(e.message)}i&&0===t.status&&this._chunkError()}},this._chunkLoaded=function(){4===t.readyState&&(t.status<200||t.status>=400?this._chunkError():(this._start+=this._config.chunkSize?this._config.chunkSize:t.responseText.length,this._finished=!this._config.chunkSize||this._start>=n(t),this.parseChunk(t.responseText)))},this._chunkError=function(e){var n=t.statusText||e;this._sendError(new Error(n))}}function p(e){var t,n;(e=e||{}).chunkSize||(e.chunkSize=o.LocalChunkSize),u.call(this,e);var i="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,n=e.slice||e.webkitSlice||e.mozSlice,i?((t=new FileReader).onload=O(this._chunkLoaded,this),t.onerror=O(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input;if(this._config.chunkSize){var s=Math.min(this._start+this._config.chunkSize,this._input.size);e=n.call(e,this._start,s)}var r=t.readAsText(e,this._config.encoding);i||this._chunkLoaded({target:{result:r}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function f(e){var t;e=e||{},u.call(this,e),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var e,n=this._config.chunkSize;return n?(e=t.substring(0,n),t=t.substring(n)):(e=t,t=""),this._finished=!t,this.parseChunk(e)}}}function g(e){e=e||{},u.call(this,e);var t=[],n=!0,i=!1;this.pause=function(){u.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){u.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){i&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):n=!0},this._streamData=O((function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),n&&(n=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(e){this._streamError(e)}}),this),this._streamError=O((function(e){this._streamCleanUp(),this._sendError(e)}),this),this._streamEnd=O((function(){this._streamCleanUp(),i=!0,this._streamData("")}),this),this._streamCleanUp=O((function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)}),this)}function m(e){var t=E.Duplex,n=k(e),i=!0,s=!1,r=[],a=null;this._onCsvData=function(e){var t=e.data;a.push(t)||this._handle.paused()||this._handle.pause()},this._onCsvComplete=function(){a.push(null)},n.step=O(this._onCsvData,this),n.complete=O(this._onCsvComplete,this),u.call(this,n),this._nextChunk=function(){s&&1===r.length&&(this._finished=!0),r.length?r.shift()():i=!0},this._addToParseQueue=function(e,t){r.push(O((function(){if(this.parseChunk("string"==typeof e?e:e.toString(n.encoding)),N(t))return t()}),this)),i&&(i=!1,this._nextChunk())},this._onRead=function(){this._handle.paused()&&this._handle.resume()},this._onWrite=function(e,t,n){this._addToParseQueue(e,n)},this._onWriteComplete=function(){s=!0,this._addToParseQueue("")},this.getStream=function(){return a},(a=new t({readableObjectMode:!0,decodeStrings:!1,read:O(this._onRead,this),write:O(this._onWrite,this)})).once("finish",O(this._onWriteComplete,this))}function w(e){var t,n,i,s=Math.pow(2,53),r=-s,a=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,c=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,l=this,d=0,u=0,h=!1,p=!1,f=[],g={data:[],errors:[],meta:{}};if(N(e.step)){var m=e.step;e.step=function(t){if(g=t,I())S();else{if(S(),0===g.data.length)return;d+=t.data.length,e.preview&&d>e.preview?n.abort():(g.data=g.data[0],m(g,l))}}}function w(t){return"greedy"===e.skipEmptyLines?""===t.join("").trim():1===t.length&&0===t[0].length}function v(e){if(a.test(e)){var t=parseFloat(e);if(t>r&&t<s)return!0}return!1}function S(){return g&&i&&(x("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+o.DefaultDelimiter+"'"),i=!1),e.skipEmptyLines&&(g.data=g.data.filter((function(e){return!w(e)}))),I()&&R(),O()}function I(){return e.header&&0===f.length}function R(){if(g)if(Array.isArray(g.data[0])){for(var t=0;I()&&t<g.data.length;t++)g.data[t].forEach(n);g.data.splice(0,1)}else g.data.forEach(n);function n(t,n){N(e.transformHeader)&&(t=e.transformHeader(t,n)),f.push(t)}}function E(t){return e.dynamicTypingFunction&&void 0===e.dynamicTyping[t]&&(e.dynamicTyping[t]=e.dynamicTypingFunction(t)),!0===(e.dynamicTyping[t]||e.dynamicTyping)}function T(e,t){return E(e)?"true"===t||"TRUE"===t||"false"!==t&&"FALSE"!==t&&(v(t)?parseFloat(t):c.test(t)?new Date(t):""===t?null:t):t}function O(){if(!g||!e.header&&!e.dynamicTyping&&!e.transform)return g;function t(t,n){var i,s=e.header?{}:[];for(i=0;i<t.length;i++){var r=i,a=t[i];e.header&&(r=i>=f.length?"__parsed_extra":f[i]),e.transform&&(a=e.transform(a,r)),a=T(r,a),"__parsed_extra"===r?(s[r]=s[r]||[],s[r].push(a)):s[r]=a}return e.header&&(i>f.length?x("FieldMismatch","TooManyFields","Too many fields: expected "+f.length+" fields but parsed "+i,u+n):i<f.length&&x("FieldMismatch","TooFewFields","Too few fields: expected "+f.length+" fields but parsed "+i,u+n)),s}var n=1;return!g.data.length||Array.isArray(g.data[0])?(g.data=g.data.map(t),n=g.data.length):g.data=t(g.data,0),e.header&&g.meta&&(g.meta.fields=f),u+=n,g}function A(t,n,i,s,r){var a,c,l,d;r=r||[",","\t","|",";",o.RECORD_SEP,o.UNIT_SEP];for(var u=0;u<r.length;u++){var h=r[u],p=0,f=0,g=0;l=void 0;for(var m=new y({comments:s,delimiter:h,newline:n,preview:10}).parse(t),b=0;b<m.data.length;b++)if(i&&w(m.data[b]))g++;else{var v=m.data[b].length;f+=v,void 0!==l?v>0&&(p+=Math.abs(v-l),l=v):l=v}m.data.length>0&&(f/=m.data.length-g),(void 0===c||p<=c)&&(void 0===d||f>d)&&f>1.99&&(c=p,a=h,d=f)}return e.delimiter=a,{successful:!!a,bestDelimiter:a}}function C(e,t){e=e.substring(0,1048576);var n=new RegExp(b(t)+"([^]*?)"+b(t),"gm"),i=(e=e.replace(n,"")).split("\r"),s=e.split("\n"),r=s.length>1&&s[0].length<i[0].length;if(1===i.length||r)return"\n";for(var a=0,o=0;o<i.length;o++)"\n"===i[o][0]&&a++;return a>=i.length/2?"\r\n":"\r"}function x(e,t,n,i){var s={type:e,code:t,message:n};void 0!==i&&(s.row=i),g.errors.push(s)}this.parse=function(s,r,a){var c=e.quoteChar||'"';if(e.newline||(e.newline=C(s,c)),i=!1,e.delimiter)N(e.delimiter)&&(e.delimiter=e.delimiter(s),g.meta.delimiter=e.delimiter);else{var l=A(s,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess);l.successful?e.delimiter=l.bestDelimiter:(i=!0,e.delimiter=o.DefaultDelimiter),g.meta.delimiter=e.delimiter}var d=k(e);return e.preview&&e.header&&d.preview++,t=s,n=new y(d),g=n.parse(t,r,a),S(),h?{meta:{paused:!0}}:g||{meta:{paused:!1}}},this.paused=function(){return h},this.pause=function(){h=!0,n.abort(),t=N(e.chunk)?"":t.substring(n.getCharIndex())},this.resume=function(){l.streamer._halted?(h=!1,l.streamer.parseChunk(t,!0)):setTimeout(l.resume,3)},this.aborted=function(){return p},this.abort=function(){p=!0,n.abort(),g.meta.aborted=!0,N(e.complete)&&e.complete(g),t=""}}function b(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(e){var t,n=(e=e||{}).delimiter,i=e.newline,s=e.comments,r=e.step,a=e.preview,c=e.fastMode,l=t=void 0===e.quoteChar||null===e.quoteChar?'"':e.quoteChar;if(void 0!==e.escapeChar&&(l=e.escapeChar),("string"!=typeof n||o.BAD_DELIMITERS.indexOf(n)>-1)&&(n=","),s===n)throw new Error("Comment character same as delimiter");!0===s?s="#":("string"!=typeof s||o.BAD_DELIMITERS.indexOf(s)>-1)&&(s=!1),"\n"!==i&&"\r"!==i&&"\r\n"!==i&&(i="\n");var d=0,u=!1;this.parse=function(o,h,p){if("string"!=typeof o)throw new Error("Input must be a string");var f=o.length,g=n.length,m=i.length,w=s.length,y=N(r);d=0;var v=[],S=[],I=[],R=0;if(!o)return Y();if(e.header&&!h){var E=o.split(i)[0].split(n),T="_",k=[],O={},A=!1;for(var C in E){var x=E[C];N(e.transformHeader)&&(x=e.transformHeader(x,C));var _=x,B=O[x]||0;for(B>0&&(A=!0,_=x+T+B),O[x]=B+1;k.includes(_);)_=_+T+B;k.push(_)}if(A){var D=o.split(i);D[0]=k.join(n),o=D.join(i)}}if(c||!1!==c&&-1===o.indexOf(t)){for(var M=o.split(i),$=0;$<M.length;$++){if(I=M[$],d+=I.length,$!==M.length-1)d+=i.length;else if(p)return Y();if(!s||I.substring(0,w)!==s){if(y){if(v=[],H(I.split(n)),K(),u)return Y()}else H(I.split(n));if(a&&$>=a)return v=v.slice(0,a),Y(!0)}}return Y()}for(var W=o.indexOf(n,d),F=o.indexOf(i,d),L=new RegExp(b(l)+b(t),"g"),P=o.indexOf(t,d);;)if(o[d]!==t)if(s&&0===I.length&&o.substring(d,d+w)===s){if(-1===F)return Y();d=F+m,F=o.indexOf(i,d),W=o.indexOf(n,d)}else if(-1!==W&&(W<F||-1===F))I.push(o.substring(d,W)),d=W+g,W=o.indexOf(n,d);else{if(-1===F)break;if(I.push(o.substring(d,F)),z(F+m),y&&(K(),u))return Y();if(a&&v.length>=a)return Y(!0)}else for(P=d,d++;;){if(-1===(P=o.indexOf(t,P+1)))return p||S.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:v.length,index:d}),G();if(P===f-1)return G(o.substring(d,P).replace(L,t));if(t!==l||o[P+1]!==l){if(t===l||0===P||o[P-1]!==l){-1!==W&&W<P+1&&(W=o.indexOf(n,P+1)),-1!==F&&F<P+1&&(F=o.indexOf(i,P+1));var j=q(-1===F?W:Math.min(W,F));if(o.substr(P+1+j,g)===n){I.push(o.substring(d,P).replace(L,t)),d=P+1+j+g,o[P+1+j+g]!==t&&(P=o.indexOf(t,d)),W=o.indexOf(n,d),F=o.indexOf(i,d);break}var U=q(F);if(o.substring(P+1+U,P+1+U+m)===i){if(I.push(o.substring(d,P).replace(L,t)),z(P+1+U+m),W=o.indexOf(n,d),P=o.indexOf(t,d),y&&(K(),u))return Y();if(a&&v.length>=a)return Y(!0);break}S.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:v.length,index:d}),P++}}else P++}return G();function H(e){v.push(e),R=d}function q(e){var t=0;if(-1!==e){var n=o.substring(P+1,e);n&&""===n.trim()&&(t=n.length)}return t}function G(e){return p||(void 0===e&&(e=o.substring(d)),I.push(e),d=f,H(I),y&&K()),Y()}function z(e){d=e,H(I),I=[],F=o.indexOf(i,d)}function Y(e){return{data:v,errors:S,meta:{delimiter:n,linebreak:i,aborted:u,truncated:!!e,cursor:R+(h||0)}}}function K(){r(Y()),v=[],S=[]}},this.abort=function(){u=!0},this.getCharIndex=function(){return d}}function v(){if(!o.WORKERS_SUPPORTED)return!1;var e=n(),i=new t.Worker(e);return i.onmessage=S,i.id=a++,r[i.id]=i,i}function S(e){var t=e.data,n=r[t.workerId],i=!1;if(t.error)n.userError(t.error,t.file);else if(t.results&&t.results.data){var s={abort:function(){i=!0,I(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:R,resume:R};if(N(n.userStep)){for(var a=0;a<t.results.data.length&&(n.userStep({data:t.results.data[a],errors:t.results.errors,meta:t.results.meta},s),!i);a++);delete t.results}else N(n.userChunk)&&(n.userChunk(t.results,s,t.file),delete t.results)}t.finished&&!i&&I(t.workerId,t.results)}function I(e,t){var n=r[e];N(n.userComplete)&&n.userComplete(t),n.terminate(),delete r[e]}function R(){throw new Error("Not implemented.")}function T(e){var n=e.data;if(void 0===o.WORKER_ID&&n&&(o.WORKER_ID=n.workerId),"string"==typeof n.input)t.postMessage({workerId:o.WORKER_ID,results:o.parse(n.input,n.config),finished:!0});else if(t.File&&n.input instanceof File||n.input instanceof Object){var i=o.parse(n.input,n.config);i&&t.postMessage({workerId:o.WORKER_ID,results:i,finished:!0})}}function k(e){if("object"!=typeof e||null===e)return e;var t=Array.isArray(e)?[]:{};for(var n in e)t[n]=k(e[n]);return t}function O(e,t){return function(){e.apply(t,arguments)}}function N(e){return"function"==typeof e}return s&&(t.onmessage=T),h.prototype=Object.create(u.prototype),h.prototype.constructor=h,p.prototype=Object.create(u.prototype),p.prototype.constructor=p,f.prototype=Object.create(f.prototype),f.prototype.constructor=f,g.prototype=Object.create(u.prototype),g.prototype.constructor=g,"undefined"==typeof PAPA_BROWSER_CONTEXT&&(m.prototype=Object.create(u.prototype),m.prototype.constructor=m),o}();var T=I;const{parse:k,unparse:O}=T;var N,A;function C(){return A?N:(A=1,N={"978-0":{name:"English language",ranges:[["00","19"],["200","227"],["2280","2289"],["229","368"],["3690","3699"],["370","638"],["6390","6397"],["6398000","6399999"],["640","644"],["6450000","6459999"],["646","647"],["6480000","6489999"],["649","654"],["6550","6559"],["656","699"],["7000","8499"],["85000","89999"],["900000","949999"],["9500000","9999999"]]},"978-1":{name:"English language",ranges:[["000","009"],["01","02"],["030","034"],["0350","0399"],["04","06"],["0700","0999"],["100","397"],["3980","5499"],["55000","64999"],["6500","6799"],["68000","68599"],["6860","7139"],["714","716"],["7170","7319"],["7320000","7399999"],["74000","77499"],["7750000","7753999"],["77540","77639"],["7764000","7764999"],["77650","77699"],["7770000","7782999"],["77830","78999"],["7900","7999"],["80000","80049"],["80050","80499"],["80500","83799"],["8380000","8384999"],["83850","86719"],["8672","8675"],["86760","86979"],["869800","915999"],["9160000","9165059"],["916506","916869"],["9168700","9169079"],["916908","919599"],["9196000","9196549"],["919655","972999"],["9730","9877"],["987800","991149"],["9911500","9911999"],["991200","998989"],["9989900","9999999"]]},"978-2":{name:"French language",ranges:[["00","19"],["200","349"],["35000","39999"],["400","489"],["490000","494999"],["495","495"],["4960","4966"],["49670","49699"],["497","699"],["7000","8399"],["84000","89999"],["900000","919799"],["91980","91980"],["919810","919942"],["9199430","9199689"],["919969","949999"],["9500000","9999999"]]},"978-3":{name:"German language",ranges:[["00","02"],["030","033"],["0340","0369"],["03700","03999"],["04","19"],["200","699"],["7000","8499"],["85000","89999"],["900000","949999"],["9500000","9539999"],["95400","96999"],["9700000","9849999"],["98500","99999"]]},"978-4":{name:"Japan",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","89999"],["900000","949999"],["9500000","9999999"]]},"978-5":{name:"former U.S.S.R",ranges:[["00000","00499"],["0050","0099"],["01","19"],["200","361"],["3620","3623"],["36240","36299"],["363","420"],["4210","4299"],["430","430"],["4310","4399"],["440","440"],["4410","4499"],["450","603"],["6040000","6049999"],["605","699"],["7000","8499"],["85000","89999"],["900000","909999"],["91000","91999"],["9200","9299"],["93000","94999"],["9500000","9500999"],["9501","9799"],["98000","98999"],["9900000","9909999"],["9910","9999"]]},"978-600":{name:"Iran",ranges:[["00","09"],["100","499"],["5000","8999"],["90000","98679"],["9868","9929"],["993","995"],["99600","99999"]]},"978-601":{name:"Kazakhstan",ranges:[["00","19"],["200","699"],["7000","7999"],["80000","84999"],["85","99"]]},"978-602":{name:"Indonesia",ranges:[["00","06"],["0700","1399"],["14000","14999"],["1500","1699"],["17000","19999"],["200","499"],["50000","53999"],["5400","5999"],["60000","61999"],["6200","6999"],["70000","74999"],["7500","9499"],["95000","99999"]]},"978-603":{name:"Saudi Arabia",ranges:[["00","04"],["05","49"],["500","799"],["8000","8999"],["90000","99999"]]},"978-604":{name:"Vietnam",ranges:[["0","2"],["300","399"],["40","46"],["470","497"],["4980","4999"],["50","89"],["900","979"],["9800","9999"]]},"978-605":{name:"Turkey",ranges:[["00","02"],["030","039"],["04","05"],["06000","06999"],["07","09"],["100","199"],["2000","2399"],["240","399"],["4000","5999"],["60000","74999"],["7500","7999"],["80000","89999"],["9000","9999"]]},"978-606":{name:"Romania",ranges:[["000","099"],["10","49"],["500","799"],["8000","9099"],["910","919"],["92000","95999"],["9600","9749"],["975","999"]]},"978-607":{name:"Mexico",ranges:[["00","39"],["400","592"],["59300","59999"],["600","749"],["7500","9499"],["95000","99999"]]},"978-608":{name:"North Macedonia",ranges:[["0","0"],["10","19"],["200","449"],["4500","6499"],["65000","69999"],["7","9"]]},"978-609":{name:"Lithuania",ranges:[["00","39"],["400","799"],["8000","9499"],["95000","99999"]]},"978-611":{name:"Thailand",ranges:[]},"978-612":{name:"Peru",ranges:[["00","29"],["300","399"],["4000","4499"],["45000","49999"],["5000","5149"]]},"978-613":{name:"Mauritius",ranges:[["0","9"]]},"978-614":{name:"Lebanon",ranges:[["00","39"],["400","799"],["8000","9499"],["95000","99999"]]},"978-615":{name:"Hungary",ranges:[["00","09"],["100","499"],["5000","7999"],["80000","89999"]]},"978-616":{name:"Thailand",ranges:[["00","19"],["200","699"],["7000","8999"],["90000","99999"]]},"978-617":{name:"Ukraine",ranges:[["00","49"],["500","699"],["7000","8999"],["90000","99999"]]},"978-618":{name:"Greece",ranges:[["00","19"],["200","499"],["5000","7999"],["80000","99999"]]},"978-619":{name:"Bulgaria",ranges:[["00","14"],["150","699"],["7000","8999"],["90000","99999"]]},"978-620":{name:"Mauritius",ranges:[["0","9"]]},"978-621":{name:"Philippines",ranges:[["00","29"],["400","599"],["8000","8999"],["95000","99999"]]},"978-622":{name:"Iran",ranges:[["00","10"],["200","374"],["5200","7999"],["92500","99999"]]},"978-623":{name:"Indonesia",ranges:[["00","09"],["130","499"],["5250","8799"],["88000","99999"]]},"978-624":{name:"Sri Lanka",ranges:[["00","04"],["200","249"],["5000","6449"],["94500","99999"]]},"978-625":{name:"Turkey",ranges:[["00","00"],["365","442"],["44300","44499"],["445","449"],["6350","7793"],["77940","77949"],["7795","8499"]]},"978-626":{name:"Taiwan",ranges:[["00","04"],["300","499"],["7000","7999"],["95000","99999"]]},"978-627":{name:"Pakistan",ranges:[["30","31"],["500","524"],["7500","7999"]]},"978-628":{name:"Colombia",ranges:[["00","09"],["500","549"],["7500","8499"],["95000","99999"]]},"978-629":{name:"Malaysia",ranges:[["00","02"],["470","499"],["7500","7999"],["96500","99999"]]},"978-630":{name:"Romania",ranges:[["300","349"],["6500","6849"]]},"978-631":{name:"Argentina",ranges:[["00","09"],["300","399"],["6500","7499"],["90000","99999"]]},"978-65":{name:"Brazil",ranges:[["00","01"],["250","299"],["300","302"],["5000","5129"],["5350","6149"],["80000","81824"],["84500","89999"],["900000","902449"],["980000","999999"]]},"978-7":{name:"China, People's Republic",ranges:[["00","09"],["100","499"],["5000","7999"],["80000","89999"],["900000","999999"]]},"978-80":{name:"former Czechoslovakia",ranges:[["00","19"],["200","529"],["53000","54999"],["550","689"],["69000","69999"],["7000","8499"],["85000","89999"],["900000","998999"],["99900","99999"]]},"978-81":{name:"India",ranges:[["00","18"],["19000","19999"],["200","699"],["7000","8499"],["85000","89999"],["900000","999999"]]},"978-82":{name:"Norway",ranges:[["00","19"],["200","689"],["690000","699999"],["7000","8999"],["90000","98999"],["990000","999999"]]},"978-83":{name:"Poland",ranges:[["00","19"],["200","599"],["60000","69999"],["7000","8499"],["85000","89999"],["900000","999999"]]},"978-84":{name:"Spain",ranges:[["00","09"],["10000","10499"],["1050","1199"],["120000","129999"],["1300","1399"],["140","149"],["15000","19999"],["200","699"],["7000","8499"],["85000","89999"],["9000","9199"],["920000","923999"],["92400","92999"],["930000","949999"],["95000","96999"],["9700","9999"]]},"978-85":{name:"Brazil",ranges:[["00","19"],["200","454"],["455000","455299"],["45530","45599"],["456","528"],["52900","53199"],["5320","5339"],["534","539"],["54000","54029"],["54030","54039"],["540400","540499"],["54050","54089"],["540900","540999"],["54100","54399"],["5440","5479"],["54800","54999"],["5500","5999"],["60000","69999"],["7000","8499"],["85000","89999"],["900000","924999"],["92500","94499"],["9450","9599"],["96","97"],["98000","99999"]]},"978-86":{name:"former Yugoslavia",ranges:[["00","29"],["300","599"],["6000","7999"],["80000","89999"],["900000","999999"]]},"978-87":{name:"Denmark",ranges:[["00","29"],["400","649"],["7000","7999"],["85000","94999"],["970000","999999"]]},"978-88":{name:"Italy",ranges:[["00","19"],["200","311"],["31200","31499"],["315","318"],["31900","32299"],["323","326"],["3270","3389"],["339","360"],["3610","3629"],["363","548"],["5490","5549"],["555","599"],["6000","8499"],["85000","89999"],["900000","909999"],["910","926"],["9270","9399"],["940000","947999"],["94800","99999"]]},"978-89":{name:"Korea, Republic",ranges:[["00","24"],["250","549"],["5500","8499"],["85000","94999"],["950000","969999"],["97000","98999"],["990","999"]]},"978-90":{name:"Netherlands",ranges:[["00","19"],["200","499"],["5000","6999"],["70000","79999"],["800000","849999"],["8500","8999"],["90","90"],["94","94"]]},"978-91":{name:"Sweden",ranges:[["0","1"],["20","49"],["500","649"],["7000","8199"],["85000","94999"],["970000","999999"]]},"978-92":{name:"International NGO Publishers and EU Organizations",ranges:[["0","5"],["60","79"],["800","899"],["9000","9499"],["95000","98999"],["990000","999999"]]},"978-93":{name:"India",ranges:[["00","09"],["100","499"],["5000","7999"],["80000","95999"],["960000","999999"]]},"978-94":{name:"Netherlands",ranges:[["000","599"],["6000","8999"],["90000","99999"]]},"978-950":{name:"Argentina",ranges:[["00","49"],["500","899"],["9000","9899"],["99000","99999"]]},"978-951":{name:"Finland",ranges:[["0","1"],["20","54"],["550","889"],["8900","9499"],["95000","99999"]]},"978-952":{name:"Finland",ranges:[["00","19"],["200","499"],["5000","5999"],["60","64"],["65000","65999"],["6600","6699"],["67000","69999"],["7000","7999"],["80","94"],["9500","9899"],["99000","99999"]]},"978-953":{name:"Croatia",ranges:[["0","0"],["10","14"],["150","479"],["48000","49999"],["500","500"],["50100","50999"],["51","54"],["55000","59999"],["6000","9499"],["95000","99999"]]},"978-954":{name:"Bulgaria",ranges:[["00","28"],["2900","2999"],["300","799"],["8000","8999"],["90000","92999"],["9300","9999"]]},"978-955":{name:"Sri Lanka",ranges:[["0000","1999"],["20","33"],["3400","3549"],["35500","35999"],["3600","3799"],["38000","38999"],["3900","4099"],["41000","44999"],["4500","4999"],["50000","54999"],["550","710"],["71100","71499"],["7150","9499"],["95000","99999"]]},"978-956":{name:"Chile",ranges:[["00","08"],["09000","09999"],["10","19"],["200","599"],["6000","6999"],["7000","9999"]]},"978-957":{name:"Taiwan",ranges:[["00","02"],["0300","0499"],["05","19"],["2000","2099"],["21","27"],["28000","30999"],["31","43"],["440","819"],["8200","9699"],["97000","99999"]]},"978-958":{name:"Colombia",ranges:[["00","49"],["500","509"],["5100","5199"],["52000","53999"],["5400","5599"],["56000","59999"],["600","799"],["8000","9499"],["95000","99999"]]},"978-959":{name:"Cuba",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","99999"]]},"978-960":{name:"Greece",ranges:[["00","19"],["200","659"],["6600","6899"],["690","699"],["7000","8499"],["85000","92999"],["93","93"],["9400","9799"],["98000","99999"]]},"978-961":{name:"Slovenia",ranges:[["00","19"],["200","599"],["6000","8999"],["90000","97999"]]},"978-962":{name:"Hong Kong, China",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","86999"],["8700","8999"],["900","999"]]},"978-963":{name:"Hungary",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","89999"],["9000","9999"]]},"978-964":{name:"Iran",ranges:[["00","14"],["150","249"],["2500","2999"],["300","549"],["5500","8999"],["90000","96999"],["970","989"],["9900","9999"]]},"978-965":{name:"Israel",ranges:[["00","19"],["200","599"],["7000","7999"],["90000","99999"]]},"978-966":{name:"Ukraine",ranges:[["00","12"],["130","139"],["14","14"],["1500","1699"],["170","199"],["2000","2789"],["279","289"],["2900","2999"],["300","699"],["7000","8999"],["90000","90999"],["910","949"],["95000","97999"],["980","999"]]},"978-967":{name:"Malaysia",ranges:[["0000","0999"],["10000","19999"],["2000","2499"],["250","254"],["25500","26999"],["2700","2799"],["2800","2999"],["300","499"],["5000","5999"],["60","89"],["900","989"],["9900","9989"],["99900","99999"]]},"978-968":{name:"Mexico",ranges:[["01","39"],["400","499"],["5000","7999"],["800","899"],["9000","9999"]]},"978-969":{name:"Pakistan",ranges:[["0","1"],["20","20"],["210","219"],["2200","2299"],["23000","23999"],["24","39"],["400","749"],["7500","9999"]]},"978-970":{name:"Mexico",ranges:[["01","59"],["600","899"],["9000","9099"],["91000","96999"],["9700","9999"]]},"978-971":{name:"Philippines",ranges:[["000","015"],["0160","0199"],["02","02"],["0300","0599"],["06","49"],["500","849"],["8500","9099"],["91000","95999"],["9600","9699"],["97","98"],["9900","9999"]]},"978-972":{name:"Portugal",ranges:[["0","1"],["20","54"],["550","799"],["8000","9499"],["95000","99999"]]},"978-973":{name:"Romania",ranges:[["0","0"],["100","169"],["1700","1999"],["20","54"],["550","759"],["7600","8499"],["85000","88999"],["8900","9499"],["95000","99999"]]},"978-974":{name:"Thailand",ranges:[["00","19"],["200","699"],["7000","8499"],["85000","89999"],["90000","94999"],["9500","9999"]]},"978-975":{name:"Turkey",ranges:[["00000","01999"],["02","23"],["2400","2499"],["250","599"],["6000","9199"],["92000","98999"],["990","999"]]},"978-976":{name:"Caribbean Community",ranges:[["0","3"],["40","59"],["600","799"],["8000","9499"],["95000","99999"]]},"978-977":{name:"Egypt",ranges:[["00","19"],["200","499"],["5000","6999"],["700","849"],["85000","89299"],["893","894"],["8950","8999"],["90","98"],["990","999"]]},"978-978":{name:"Nigeria",ranges:[["000","199"],["2000","2999"],["30000","77999"],["780","799"],["8000","8999"],["900","999"]]},"978-979":{name:"Indonesia",ranges:[["000","099"],["1000","1499"],["15000","19999"],["20","29"],["3000","3999"],["400","799"],["8000","9499"],["95000","99999"]]},"978-980":{name:"Venezuela",ranges:[["00","19"],["200","599"],["6000","9999"]]},"978-981":{name:"Singapore",ranges:[["00","16"],["17000","17999"],["18","19"],["200","299"],["3000","3099"],["310","399"],["4000","9499"],["99","99"]]},"978-982":{name:"South Pacific",ranges:[["00","09"],["100","699"],["70","89"],["9000","9799"],["98000","99999"]]},"978-983":{name:"Malaysia",ranges:[["00","01"],["020","199"],["2000","3999"],["40000","44999"],["45","49"],["50","79"],["800","899"],["9000","9899"],["99000","99999"]]},"978-984":{name:"Bangladesh",ranges:[["00","39"],["400","799"],["8000","8999"],["90000","99999"]]},"978-985":{name:"Belarus",ranges:[["00","39"],["400","599"],["6000","8799"],["880","899"],["90000","99999"]]},"978-986":{name:"Taiwan",ranges:[["00","05"],["06000","06999"],["0700","0799"],["08","11"],["120","539"],["5400","7999"],["80000","99999"]]},"978-987":{name:"Argentina",ranges:[["00","09"],["1000","1999"],["20000","29999"],["30","35"],["3600","4199"],["42","43"],["4400","4499"],["45000","48999"],["4900","4999"],["500","824"],["8250","8279"],["82800","82999"],["8300","8499"],["85","88"],["8900","9499"],["95000","99999"]]},"978-988":{name:"Hong Kong, China",ranges:[["00","11"],["12000","19999"],["200","699"],["70000","79999"],["8000","9699"],["97000","99999"]]},"978-989":{name:"Portugal",ranges:[["0","1"],["20","34"],["35000","36999"],["37","52"],["53000","54999"],["550","799"],["8000","9499"],["95000","99999"]]},"978-9911":{name:"Montenegro",ranges:[["20","24"],["550","749"]]},"978-9912":{name:"Tanzania",ranges:[["40","44"],["750","799"],["9800","9999"]]},"978-9913":{name:"Uganda",ranges:[["00","07"],["600","699"],["9550","9999"]]},"978-9914":{name:"Kenya",ranges:[["40","52"],["700","774"],["9600","9999"]]},"978-9915":{name:"Uruguay",ranges:[["40","59"],["650","799"],["9300","9999"]]},"978-9916":{name:"Estonia",ranges:[["0","0"],["10","39"],["4","5"],["600","799"],["9500","9999"]]},"978-9917":{name:"Bolivia",ranges:[["0","0"],["30","34"],["600","699"],["9800","9999"]]},"978-9918":{name:"Malta",ranges:[["0","0"],["20","29"],["600","799"],["9500","9999"]]},"978-9919":{name:"Mongolia",ranges:[["0","0"],["20","29"],["500","599"],["9000","9999"]]},"978-9920":{name:"Morocco",ranges:[["30","41"],["500","799"],["8750","9999"]]},"978-9921":{name:"Kuwait",ranges:[["0","0"],["30","39"],["700","899"],["9700","9999"]]},"978-9922":{name:"Iraq",ranges:[["20","29"],["600","799"],["8500","9999"]]},"978-9923":{name:"Jordan",ranges:[["0","0"],["10","59"],["700","899"],["9400","9999"]]},"978-9924":{name:"Cambodia",ranges:[["30","39"],["500","649"],["9000","9999"]]},"978-9925":{name:"Cyprus",ranges:[["0","2"],["30","54"],["550","734"],["7350","9999"]]},"978-9926":{name:"Bosnia and Herzegovina",ranges:[["0","1"],["20","39"],["400","799"],["8000","9999"]]},"978-9927":{name:"Qatar",ranges:[["00","09"],["100","399"],["4000","4999"]]},"978-9928":{name:"Albania",ranges:[["00","09"],["100","399"],["4000","4999"],["800","899"],["90","99"]]},"978-9929":{name:"Guatemala",ranges:[["0","3"],["40","54"],["550","799"],["8000","9999"]]},"978-9930":{name:"Costa Rica",ranges:[["00","49"],["500","939"],["9400","9999"]]},"978-9931":{name:"Algeria",ranges:[["00","23"],["240","899"],["9000","9999"]]},"978-9932":{name:"Lao People's Democratic Republic",ranges:[["00","39"],["400","849"],["8500","9999"]]},"978-9933":{name:"Syria",ranges:[["0","0"],["10","39"],["400","899"],["9000","9999"]]},"978-9934":{name:"Latvia",ranges:[["0","0"],["10","49"],["500","799"],["8000","9999"]]},"978-9935":{name:"Iceland",ranges:[["0","0"],["10","39"],["400","899"],["9000","9999"]]},"978-9936":{name:"Afghanistan",ranges:[["0","1"],["20","39"],["400","799"],["8000","9999"]]},"978-9937":{name:"Nepal",ranges:[["0","2"],["30","49"],["500","799"],["8000","9999"]]},"978-9938":{name:"Tunisia",ranges:[["00","79"],["800","949"],["9500","9749"],["975","990"],["9910","9999"]]},"978-9939":{name:"Armenia",ranges:[["0","4"],["50","79"],["800","899"],["9000","9599"],["960","979"],["98","99"]]},"978-9940":{name:"Montenegro",ranges:[["0","1"],["20","49"],["500","839"],["84","86"],["8700","9999"]]},"978-9941":{name:"Georgia",ranges:[["0","0"],["10","39"],["400","799"],["8","8"],["9000","9999"]]},"978-9942":{name:"Ecuador",ranges:[["00","59"],["600","699"],["7000","7499"],["750","849"],["8500","8999"],["900","984"],["9850","9999"]]},"978-9943":{name:"Uzbekistan",ranges:[["00","29"],["300","399"],["4000","9749"],["975","999"]]},"978-9944":{name:"Turkey",ranges:[["0000","0999"],["100","499"],["5000","5999"],["60","69"],["700","799"],["80","89"],["900","999"]]},"978-9945":{name:"Dominican Republic",ranges:[["00","00"],["010","079"],["08","39"],["400","569"],["57","57"],["580","799"],["80","80"],["810","849"],["8500","9999"]]},"978-9946":{name:"Korea, P.D.R.",ranges:[["0","1"],["20","39"],["400","899"],["9000","9999"]]},"978-9947":{name:"Algeria",ranges:[["0","1"],["20","79"],["800","999"]]},"978-9948":{name:"United Arab Emirates",ranges:[["00","39"],["400","849"],["8500","9999"]]},"978-9949":{name:"Estonia",ranges:[["00","08"],["090","099"],["10","39"],["400","699"],["70","71"],["7200","7499"],["75","89"],["9000","9999"]]},"978-9950":{name:"Palestine",ranges:[["00","29"],["300","849"],["8500","9999"]]},"978-9951":{name:"Kosova",ranges:[["00","38"],["390","849"],["8500","9799"],["980","999"]]},"978-9952":{name:"Azerbaijan",ranges:[["0","1"],["20","39"],["400","799"],["8000","9999"]]},"978-9953":{name:"Lebanon",ranges:[["0","0"],["10","39"],["400","599"],["60","89"],["9000","9299"],["93","96"],["970","999"]]},"978-9954":{name:"Morocco",ranges:[["0","1"],["20","39"],["400","799"],["8000","9899"],["99","99"]]},"978-9955":{name:"Lithuania",ranges:[["00","39"],["400","929"],["9300","9999"]]},"978-9956":{name:"Cameroon",ranges:[["0","0"],["10","39"],["400","899"],["9000","9999"]]},"978-9957":{name:"Jordan",ranges:[["00","39"],["400","649"],["65","67"],["680","699"],["70","84"],["8500","8799"],["88","99"]]},"978-9958":{name:"Bosnia and Herzegovina",ranges:[["00","01"],["020","029"],["0300","0399"],["040","089"],["0900","0999"],["10","18"],["1900","1999"],["20","49"],["500","899"],["9000","9999"]]},"978-9959":{name:"Libya",ranges:[["0","1"],["20","79"],["800","949"],["9500","9699"],["970","979"],["98","99"]]},"978-9960":{name:"Saudi Arabia",ranges:[["00","59"],["600","899"],["9000","9999"]]},"978-9961":{name:"Algeria",ranges:[["0","2"],["30","69"],["700","949"],["9500","9999"]]},"978-9962":{name:"Panama",ranges:[["00","54"],["5500","5599"],["56","59"],["600","849"],["8500","9999"]]},"978-9963":{name:"Cyprus",ranges:[["0","1"],["2000","2499"],["250","279"],["2800","2999"],["30","54"],["550","734"],["7350","7499"],["7500","9999"]]},"978-9964":{name:"Ghana",ranges:[["0","6"],["70","94"],["950","999"]]},"978-9965":{name:"Kazakhstan",ranges:[["00","39"],["400","899"],["9000","9999"]]},"978-9966":{name:"Kenya",ranges:[["000","139"],["14","14"],["1500","1999"],["20","69"],["7000","7499"],["750","820"],["8210","8249"],["825","825"],["8260","8289"],["829","959"],["9600","9999"]]},"978-9967":{name:"Kyrgyz Republic",ranges:[["00","39"],["400","899"],["9000","9999"]]},"978-9968":{name:"Costa Rica",ranges:[["00","49"],["500","939"],["9400","9999"]]},"978-9969":{name:"Algeria",ranges:[["00","06"],["500","649"],["9700","9999"]]},"978-9970":{name:"Uganda",ranges:[["00","39"],["400","899"],["9000","9999"]]},"978-9971":{name:"Singapore",ranges:[["0","5"],["60","89"],["900","989"],["9900","9999"]]},"978-9972":{name:"Peru",ranges:[["00","09"],["1","1"],["200","249"],["2500","2999"],["30","59"],["600","899"],["9000","9999"]]},"978-9973":{name:"Tunisia",ranges:[["00","05"],["060","089"],["0900","0999"],["10","69"],["700","969"],["9700","9999"]]},"978-9974":{name:"Uruguay",ranges:[["0","2"],["30","54"],["550","749"],["7500","8799"],["880","909"],["91","94"],["95","99"]]},"978-9975":{name:"Moldova",ranges:[["0","0"],["100","299"],["3000","3999"],["4000","4499"],["45","89"],["900","949"],["9500","9999"]]},"978-9976":{name:"Tanzania",ranges:[["0","4"],["5000","5799"],["580","589"],["59","89"],["900","989"],["9900","9999"]]},"978-9977":{name:"Costa Rica",ranges:[["00","89"],["900","989"],["9900","9999"]]},"978-9978":{name:"Ecuador",ranges:[["00","29"],["300","399"],["40","94"],["950","989"],["9900","9999"]]},"978-9979":{name:"Iceland",ranges:[["0","4"],["50","64"],["650","659"],["66","75"],["760","899"],["9000","9999"]]},"978-9980":{name:"Papua New Guinea",ranges:[["0","3"],["40","89"],["900","989"],["9900","9999"]]},"978-9981":{name:"Morocco",ranges:[["00","09"],["100","159"],["1600","1999"],["20","79"],["800","949"],["9500","9999"]]},"978-9982":{name:"Zambia",ranges:[["00","79"],["800","989"],["9900","9999"]]},"978-9983":{name:"Gambia",ranges:[["80","94"],["950","989"],["9900","9999"]]},"978-9984":{name:"Latvia",ranges:[["00","49"],["500","899"],["9000","9999"]]},"978-9985":{name:"Estonia",ranges:[["0","4"],["50","79"],["800","899"],["9000","9999"]]},"978-9986":{name:"Lithuania",ranges:[["00","39"],["400","899"],["9000","9399"],["940","969"],["97","99"]]},"978-9987":{name:"Tanzania",ranges:[["00","39"],["400","879"],["8800","9999"]]},"978-9988":{name:"Ghana",ranges:[["0","3"],["40","54"],["550","749"],["7500","9999"]]},"978-9989":{name:"North Macedonia",ranges:[["0","0"],["100","199"],["2000","2999"],["30","59"],["600","949"],["9500","9999"]]},"978-99901":{name:"Bahrain",ranges:[["00","49"],["500","799"],["80","99"]]},"978-99902":{name:"Reserved Agency",ranges:[]},"978-99903":{name:"Mauritius",ranges:[["0","1"],["20","89"],["900","999"]]},"978-99904":{name:"Curaçao",ranges:[["0","5"],["60","89"],["900","999"]]},"978-99905":{name:"Bolivia",ranges:[["0","3"],["40","79"],["800","999"]]},"978-99906":{name:"Kuwait",ranges:[["0","2"],["30","59"],["600","699"],["70","89"],["90","94"],["950","999"]]},"978-99908":{name:"Malawi",ranges:[["0","0"],["10","89"],["900","999"]]},"978-99909":{name:"Malta",ranges:[["0","3"],["40","94"],["950","999"]]},"978-99910":{name:"Sierra Leone",ranges:[["0","2"],["30","89"],["900","999"]]},"978-99911":{name:"Lesotho",ranges:[["00","59"],["600","999"]]},"978-99912":{name:"Botswana",ranges:[["0","3"],["400","599"],["60","89"],["900","999"]]},"978-99913":{name:"Andorra",ranges:[["0","2"],["30","35"],["600","604"]]},"978-99914":{name:"International NGO Publishers",ranges:[["0","4"],["50","69"],["7","7"],["80","89"],["900","999"]]},"978-99915":{name:"Maldives",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99916":{name:"Namibia",ranges:[["0","2"],["30","69"],["700","999"]]},"978-99917":{name:"Brunei Darussalam",ranges:[["0","2"],["30","88"],["890","999"]]},"978-99918":{name:"Faroe Islands",ranges:[["0","3"],["40","79"],["800","999"]]},"978-99919":{name:"Benin",ranges:[["0","2"],["300","399"],["40","79"],["800","999"]]},"978-99920":{name:"Andorra",ranges:[["0","4"],["50","89"],["900","999"]]},"978-99921":{name:"Qatar",ranges:[["0","1"],["20","69"],["700","799"],["8","8"],["90","99"]]},"978-99922":{name:"Guatemala",ranges:[["0","3"],["40","69"],["700","999"]]},"978-99923":{name:"El Salvador",ranges:[["0","1"],["20","79"],["800","999"]]},"978-99924":{name:"Nicaragua",ranges:[["0","1"],["20","79"],["800","999"]]},"978-99925":{name:"Paraguay",ranges:[["0","0"],["10","19"],["200","299"],["3","3"],["40","79"],["800","999"]]},"978-99926":{name:"Honduras",ranges:[["0","0"],["10","59"],["600","869"],["87","89"],["90","99"]]},"978-99927":{name:"Albania",ranges:[["0","2"],["30","59"],["600","999"]]},"978-99928":{name:"Georgia",ranges:[["0","0"],["10","79"],["800","999"]]},"978-99929":{name:"Mongolia",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99930":{name:"Armenia",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99931":{name:"Seychelles",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99932":{name:"Malta",ranges:[["0","0"],["10","59"],["600","699"],["7","7"],["80","99"]]},"978-99933":{name:"Nepal",ranges:[["0","2"],["30","59"],["600","999"]]},"978-99934":{name:"Dominican Republic",ranges:[["0","1"],["20","79"],["800","999"]]},"978-99935":{name:"Haiti",ranges:[["0","2"],["30","59"],["600","699"],["7","8"],["90","99"]]},"978-99936":{name:"Bhutan",ranges:[["0","0"],["10","59"],["600","999"]]},"978-99937":{name:"Macau",ranges:[["0","1"],["20","59"],["600","999"]]},"978-99938":{name:"Srpska, Republic of",ranges:[["0","1"],["20","59"],["600","899"],["90","99"]]},"978-99939":{name:"Guatemala",ranges:[["0","2"],["30","59"],["60","89"],["900","999"]]},"978-99940":{name:"Georgia",ranges:[["0","0"],["10","69"],["700","999"]]},"978-99941":{name:"Armenia",ranges:[["0","2"],["30","79"],["800","999"]]},"978-99942":{name:"Sudan",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99943":{name:"Albania",ranges:[["0","2"],["30","59"],["600","999"]]},"978-99944":{name:"Ethiopia",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99945":{name:"Namibia",ranges:[["0","4"],["50","89"],["900","999"]]},"978-99946":{name:"Nepal",ranges:[["0","2"],["30","59"],["600","999"]]},"978-99947":{name:"Tajikistan",ranges:[["0","2"],["30","69"],["700","999"]]},"978-99948":{name:"Eritrea",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99949":{name:"Mauritius",ranges:[["0","1"],["20","79"],["8","8"],["900","989"],["99","99"]]},"978-99950":{name:"Cambodia",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99951":{name:"Reserved Agency",ranges:[]},"978-99952":{name:"Mali",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99953":{name:"Paraguay",ranges:[["0","2"],["30","79"],["800","939"],["94","99"]]},"978-99954":{name:"Bolivia",ranges:[["0","2"],["30","69"],["700","879"],["88","99"]]},"978-99955":{name:"Srpska, Republic of",ranges:[["0","1"],["20","59"],["600","799"],["80","99"]]},"978-99956":{name:"Albania",ranges:[["00","59"],["600","859"],["86","99"]]},"978-99957":{name:"Malta",ranges:[["0","1"],["20","79"],["800","949"],["95","99"]]},"978-99958":{name:"Bahrain",ranges:[["0","4"],["50","93"],["940","949"],["950","999"]]},"978-99959":{name:"Luxembourg",ranges:[["0","2"],["30","59"],["600","999"]]},"978-99960":{name:"Malawi",ranges:[["070","099"],["10","94"],["950","999"]]},"978-99961":{name:"El Salvador",ranges:[["0","2"],["300","369"],["37","89"],["900","999"]]},"978-99962":{name:"Mongolia",ranges:[["0","4"],["50","79"],["800","999"]]},"978-99963":{name:"Cambodia",ranges:[["00","49"],["500","919"],["92","99"]]},"978-99964":{name:"Nicaragua",ranges:[["0","1"],["20","79"],["800","999"]]},"978-99965":{name:"Macau",ranges:[["0","2"],["300","359"],["36","62"],["630","999"]]},"978-99966":{name:"Kuwait",ranges:[["0","2"],["30","69"],["700","799"],["80","96"],["970","999"]]},"978-99967":{name:"Paraguay",ranges:[["0","0"],["10","59"],["600","999"]]},"978-99968":{name:"Botswana",ranges:[["0","3"],["400","599"],["60","89"],["900","999"]]},"978-99969":{name:"Oman",ranges:[["0","4"],["50","79"],["800","949"],["95","99"]]},"978-99970":{name:"Haiti",ranges:[["0","4"],["50","89"],["900","999"]]},"978-99971":{name:"Myanmar",ranges:[["0","3"],["40","84"],["850","999"]]},"978-99972":{name:"Faroe Islands",ranges:[["0","4"],["50","89"],["900","999"]]},"978-99973":{name:"Mongolia",ranges:[["0","3"],["40","79"],["800","999"]]},"978-99974":{name:"Bolivia",ranges:[["0","0"],["10","25"],["260","399"],["40","63"],["640","649"],["65","79"],["800","999"]]},"978-99975":{name:"Tajikistan",ranges:[["0","2"],["300","399"],["40","79"],["800","999"]]},"978-99976":{name:"Srpska, Republic of",ranges:[["0","0"],["10","15"],["160","199"],["20","59"],["600","799"],["85","89"],["900","999"]]},"978-99977":{name:"Rwanda",ranges:[["0","1"],["40","69"],["700","799"],["995","999"]]},"978-99978":{name:"Mongolia",ranges:[["0","4"],["50","69"],["700","999"]]},"978-99979":{name:"Honduras",ranges:[["0","3"],["40","79"],["800","999"]]},"978-99980":{name:"Bhutan",ranges:[["0","0"],["30","59"],["750","999"]]},"978-99981":{name:"Macau",ranges:[["0","1"],["27","74"],["750","999"]]},"978-99982":{name:"Benin",ranges:[["0","1"],["50","68"],["900","999"]]},"978-99983":{name:"El Salvador",ranges:[["0","0"],["50","69"],["950","999"]]},"978-99984":{name:"Brunei Darussalam",ranges:[["0","0"],["50","69"],["950","999"]]},"978-99985":{name:"Tajikistan",ranges:[["0","1"],["35","79"],["850","999"]]},"978-99986":{name:"Myanmar",ranges:[["0","0"],["50","69"],["950","999"]]},"978-99987":{name:"Luxembourg",ranges:[["700","999"]]},"978-99988":{name:"Sudan",ranges:[["0","0"],["50","54"],["800","824"]]},"978-99989":{name:"Paraguay",ranges:[["0","0"],["50","64"],["900","999"]]},"978-99990":{name:"Ethiopia",ranges:[["0","0"],["50","54"],["975","999"]]},"978-99992":{name:"Oman",ranges:[["0","1"],["50","64"],["950","999"]]},"979-10":{name:"France",ranges:[["00","19"],["200","699"],["7000","8999"],["90000","97599"],["976000","999999"]]},"979-11":{name:"Korea, Republic",ranges:[["00","24"],["250","549"],["5500","8499"],["85000","94999"],["950000","999999"]]},"979-12":{name:"Italy",ranges:[["200","299"],["5450","5999"],["80000","84999"]]},"979-8":{name:"United States",ranges:[["200","229"],["3500","3999"],["4000","8499"],["8500","8849"],["88500","89999"],["9850000","9899999"]]}})}var x=e=>{let t=0;if(9===e.length){for(let n=0;n<9;n+=1)t+=(10-n)*e.charAt(n);return t=(11-t%11)%11,10===t?"X":String(t)}if(12===e.length){for(let n=0;n<12;n+=2)t+=Number(e.charAt(n))+3*e.charAt(n+1);return String((10-t%10)%10)}return null};const _=C(),B=x;const D=C(),M={};Object.keys(D).forEach((e=>{const[t,n]=e.split("-"),i=n[0];M[t]=M[t]||{},M[t][i]=M[t][i]||{},M[t][i][n]=D[e]}));const $=e=>{const t=e.substring(0,3);if(!M[t])return null;const n=e.substring(3),i=n[0],s=M[t];if(!s)return null;const r=s[i];for(let e in r)if(n.startsWith(e))return{group:e,ranges:r[e].ranges,restAfterGroup:n.slice(e.length)};return null};const W=e=>{const t=$(e);if(!t)return null;const{group:n,ranges:i,restAfterGroup:s}=t;for(let e of i){const[t,i]=e,r=s.substr(0,t.length);if(t<=r&&i>=r){const e=s.substr(r.length);return{group:n,publisher:r,article:e.slice(0,-1),check:e.slice(-1)}}}return null},F=e=>{if(!e)return null;const t=e.prefix||"978",{group:n,publisher:i,article:s}=e,r=_[`${t}-${n}`];if(!r)return null;e.groupname=r.name;const a=`${n}${i}${s}`,o=e.check10=B(a);if(!o)return null;const c=e.check13=B(t+a);return c?(e.isbn13=`${t}${n}${i}${s}${c}`,e.isbn13h=`${t}-${n}-${i}-${s}-${c}`,"978"===t&&(e.isbn10=`${n}${i}${s}${o}`,e.isbn10h=`${n}-${i}-${s}-${o}`),e):null},L=e=>(10===e.length&&(e="978"+e),13===e.length?W(e):null);var P=e=>{const t=e=e.toString();if(!e)return null;e=e.replace(/\s/g,"").replace(/-/g,"");let n=L(e);return n?(n.source=t,13===e.length?(n.prefix=e.substring(0,3),n.isIsbn13=!0,n.isIsbn10=!1):(n.isIsbn10=!0,n.isIsbn13=!1),n=F(n),n?(n.isValid=n.check===(n.isIsbn13?n.check13:n.check10),n.isValid?n:null):null):null};const j=P,U=x;const H=(e,t,n)=>{const i=`${t}${e.substring(3,12)}`,s=U(i),r=j(`${i}${s}`);if(null!=r){const{isbn13h:e,isbn13:t,groupname:i}=r;n.push({message:"possible prefix error",candidate:e,isbn13:t,groupname:i})}},q=(e,t,n)=>{const i=`${t}${e.substring(3)}`,s=j(i);if(null!=s){const{isbn13h:e,isbn13:t,groupname:i}=s;n.push({message:"checksum hints different prefix",candidate:e,isbn13:t,groupname:i})}},G=e=>e.replace(/[^\dX]/g,""),z=P;var Y={parse:z,audit:e=>{if("string"!=typeof e||0===e.length)throw Error(`invalid input: ${e}`);const t={source:e},n=j(e);t.validIsbn=null!=n;const i=[],s=G(e);return n?(t.groupname=n.groupname,13===s.length&&(s.startsWith("978")?H(s,"979",i):s.startsWith("979")&&H(s,"978",i))):13===s.length&&(s.startsWith("978")?q(s,"979",i):s.startsWith("979")&&q(s,"978",i)),t.clues=i,t},hyphenate:e=>{const t=z(e);return t?t.isIsbn13?t.isbn13h:t.isbn10h:null},asIsbn13:(e,t)=>{const n=z(e);return n?t?n.isbn13h:n.isbn13:null},asIsbn10:(e,t)=>{const n=z(e);return n&&n.isbn10?t?n.isbn10h:n.isbn10:null},groups:C()};const K=/^[a-zA-Z_][a-zA-Z0-9_]*$/;function J(e){return null===e?"null":void 0===e?"undefined":""===e?"an empty string":"symbol"==typeof e?`<${e.toString()}>`:Array.isArray(e)?"an array":JSON.stringify(e)}function V(e,t){var n,i,s;return"number"==typeof t?`${null!==(n=null==e?void 0:e.p)&&void 0!==n?n:"."}[${t}]`:K.test(t)?`${null!==(i=null==e?void 0:e.p)&&void 0!==i?i:""}.${t}`:`${null!==(s=null==e?void 0:e.p)&&void 0!==s?s:"."}[${JSON.stringify(t)}]`}function Q({errors:e,p:t}={},n){return null==e||e.push(`${null!=t?t:"."}: ${n}`),!1}function X(e,t){return n=>{e[t]=n}}function Z(e,t){return n=>{const i=e[t];return e[t]=n,Z(e,t).bind(null,i)}}function ee(){return ce({test:(e,t)=>!0})}function te(){return ce({test:(e,t)=>"string"==typeof e||Q(t,`Expected a string (got ${J(e)})`)})}function ne(){return ce({test:(e,t)=>{var n;if("number"!=typeof e){if(void 0!==(null==t?void 0:t.coercions)){if(void 0===(null==t?void 0:t.coercion))return Q(t,"Unbound coercion result");let i;if("string"==typeof e){let n;try{n=JSON.parse(e)}catch(e){}if("number"==typeof n){if(JSON.stringify(n)!==e)return Q(t,`Received a number that can't be safely represented by the runtime (${e})`);i=n}}if(void 0!==i)return t.coercions.push([null!==(n=t.p)&&void 0!==n?n:".",t.coercion.bind(null,i)]),!0}return Q(t,`Expected a number (got ${J(e)})`)}return!0}})}function ie(e,{delimiter:t}={}){return ce({test:(n,i)=>{var s;const r=n;if("string"==typeof n&&void 0!==t&&void 0!==(null==i?void 0:i.coercions)){if(void 0===(null==i?void 0:i.coercion))return Q(i,"Unbound coercion result");n=n.split(t)}if(!Array.isArray(n))return Q(i,`Expected an array (got ${J(n)})`);let a=!0;for(let t=0,s=n.length;t<s&&(a=e(n[t],Object.assign(Object.assign({},i),{p:V(i,t),coercion:Z(n,t)}))&&a,a||null!=(null==i?void 0:i.errors));++t);return n!==r&&i.coercions.push([null!==(s=i.p)&&void 0!==s?s:".",i.coercion.bind(null,n)]),a}})}function se(e,{delimiter:t}={}){const n=(i=e.length,ce({test:(e,t)=>e.length===i||Q(t,`Expected to have a length of exactly ${i} elements (got ${e.length})`)}));var i;return ce({test:(i,s)=>{var r;if("string"==typeof i&&void 0!==t&&void 0!==(null==s?void 0:s.coercions)){if(void 0===(null==s?void 0:s.coercion))return Q(s,"Unbound coercion result");i=i.split(t),s.coercions.push([null!==(r=s.p)&&void 0!==r?r:".",s.coercion.bind(null,i)])}if(!Array.isArray(i))return Q(s,`Expected a tuple (got ${J(i)})`);let a=n(i,Object.assign({},s));for(let t=0,n=i.length;t<n&&t<e.length&&(a=e[t](i[t],Object.assign(Object.assign({},s),{p:V(s,t),coercion:Z(i,t)}))&&a,a||null!=(null==s?void 0:s.errors));++t);return a}})}function re(e,{keys:t=null}={}){const n=ie(se([null!=t?t:te(),e]));return ce({test:(i,s)=>{var r;if(Array.isArray(i)&&void 0!==(null==s?void 0:s.coercions))return void 0===(null==s?void 0:s.coercion)?Q(s,"Unbound coercion result"):!!n(i,Object.assign(Object.assign({},s),{coercion:void 0}))&&(i=Object.fromEntries(i),s.coercions.push([null!==(r=s.p)&&void 0!==r?r:".",s.coercion.bind(null,i)]),!0);if("object"!=typeof i||null===i)return Q(s,`Expected an object (got ${J(i)})`);const a=Object.keys(i);let o=!0;for(let n=0,r=a.length;n<r&&(o||null!=(null==s?void 0:s.errors));++n){const r=a[n],c=i[r];"__proto__"!==r&&"constructor"!==r?(null===t||t(r,s))&&e(c,Object.assign(Object.assign({},s),{p:V(s,r),coercion:Z(i,r)}))||(o=!1):o=Q(Object.assign(Object.assign({},s),{p:V(s,r)}),"Unsafe property name")}return o}})}function ae(e,{extra:t=null}={}){const n=Object.keys(e),i=ce({test:(i,s)=>{if("object"!=typeof i||null===i)return Q(s,`Expected an object (got ${J(i)})`);const r=new Set([...n,...Object.keys(i)]),a={};let o=!0;for(const n of r){if("constructor"===n||"__proto__"===n)o=Q(Object.assign(Object.assign({},s),{p:V(s,n)}),"Unsafe property name");else{const r=Object.prototype.hasOwnProperty.call(e,n)?e[n]:void 0,c=Object.prototype.hasOwnProperty.call(i,n)?i[n]:void 0;void 0!==r?o=r(c,Object.assign(Object.assign({},s),{p:V(s,n),coercion:Z(i,n)}))&&o:null===t?o=Q(Object.assign(Object.assign({},s),{p:V(s,n)}),`Extraneous property (got ${J(c)})`):Object.defineProperty(a,n,{enumerable:!0,get:()=>c,set:X(i,n)})}if(!o&&null==(null==s?void 0:s.errors))break}return null===t||!o&&null==(null==s?void 0:s.errors)||(o=t(a,s)&&o),o}});return Object.assign(i,{properties:e})}function oe(e){return ae(e,{extra:re(ee())})}function ce({test:e}){return(t=e,()=>t)();var t}class le extends Error{constructor({errors:e}={}){let t="Type mismatch";if(e&&e.length>0){t+="\n";for(const n of e)t+=`\n- ${n}`}super(t)}}function de(e,t,{coerce:n=!1,errors:i,throw:s}={}){const r=i?[]:void 0;if(!n){if(t(e,{errors:r}))return s?e:{value:e,errors:void 0};if(s)throw new le({errors:r});return{value:void 0,errors:null==r||r}}const a={value:e},o=[];if(!t(e,{errors:r,coercion:Z(a,"value"),coercions:o})){if(s)throw new le({errors:r});return{value:void 0,errors:null==r||r}}for(const[,e]of o)e();return s?a.value:{value:a.value,errors:void 0}}function ue(e){return ce({test:(t,n)=>void 0===t||e(t,n)})}var he;!function(e){e.Forbids="Forbids",e.Requires="Requires"}(he||(he={})),he.Forbids,he.Requires;class pe extends Error{constructor(){super("Throttled function aborted"),this.name="AbortError"}}function fe({limit:e,interval:t,strict:n}){if(!Number.isFinite(e))throw new TypeError("Expected `limit` to be a finite number");if(!Number.isFinite(t))throw new TypeError("Expected `interval` to be a finite number");const i=new Map;let s=0,r=0;const a=[];const o=n?function(){const n=Date.now();if(a.length<e)return a.push(n),0;const i=a.shift()+t;return n>=i?(a.push(n),0):(a.push(i),i-n)}:function(){const n=Date.now();return n-s>t?(r=1,s=n,0):(r<e?r++:(s+=t,r=1),s-n)};return e=>{const t=function(...n){if(!t.isEnabled)return(async()=>e.apply(this,n))();let s;return new Promise(((t,r)=>{s=setTimeout((()=>{t(e.apply(this,n)),i.delete(s)}),o()),i.set(s,r)}))};return t.abort=()=>{for(const e of i.keys())clearTimeout(e),i.get(e)(new pe);i.clear(),a.splice(0,a.length)},t.isEnabled=!0,t}}class ge{value;next;constructor(e){this.value=e}}class me{#e;#t;#n;constructor(){this.clear()}enqueue(e){const t=new ge(e);this.#e?(this.#t.next=t,this.#t=t):(this.#e=t,this.#t=t),this.#n++}dequeue(){const e=this.#e;if(e)return this.#e=this.#e.next,this.#n--,e.value}clear(){this.#e=void 0,this.#t=void 0,this.#n=0}get size(){return this.#n}*[Symbol.iterator](){let e=this.#e;for(;e;)yield e.value,e=e.next}}function we(e){if(!Number.isInteger(e)&&e!==Number.POSITIVE_INFINITY||!(e>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up");const t=new me;let n=0;const i=async(e,i,s)=>{n++;const r=(async()=>e(...s))();i(r);try{await r}catch{}n--,t.size>0&&t.dequeue()()},s=(s,...r)=>new Promise((a=>{((s,r,a)=>{t.enqueue(i.bind(void 0,s,r,a)),(async()=>{await Promise.resolve(),n<e&&t.size>0&&t.dequeue()()})()})(s,a,r)}));return Object.defineProperties(s,{activeCount:{get:()=>n},pendingCount:{get:()=>t.size},clearQueue:{value:()=>{t.clear()}}}),s}async function be(e){return new Promise((t=>{const n=new Array;!function(e,t){let n,i=!1;k(e,{step:function(e){if(e.errors?.length>0)throw{error:"ParseError",offset:e.meta.cursor,details:e.errors};{const s=e.data;if(1==s.length&&""==s[0])i=!0;else if(n){i&&(t.row({},{empty:!0,offset:e.meta.cursor,extraColumns:[],missingColumns:n}),i=!1);const r=Object.fromEntries(n.flatMap(((e,t)=>t>=s.length?[]:[[e,s[t]]]))),a={offset:e.meta.cursor,missingColumns:[],extraColumns:[]};s.length>n.length?a.extraColumns=s.slice(n.length):s.length<n.length&&(a.missingColumns=n.slice(s.length)),t.row(r,a)}else n=Object.freeze(s)}},complete(){t.done?.()}})}(e,{row(e){n.push(e)},done(){t(n)}})}))}function ye(e){return e.replace(/\s|-/g,"").toUpperCase()}function ve(e){const t=Y.parse(e);return t?.isbn10&&t.isbn13?[t.isbn13,t.isbn10]:t?.isbn13?[t.isbn13]:[ye(e)]}const Se=ie(se([ee(),ee()])),Ie=ae({version:(Re=2,ce({test:(e,t)=>e===Re||Q(t,`Expected ${J(Re)} (got ${J(e)})`)})),data:ie(se([ee(),ee(),ne()]))});var Re;function Ee(e,t){const n=new Map,i=new Map,s=function(e,t,n){const i=2592e6;let s;if(t)if("restoreArgument"in t)if(t.import)if(Se(t.import))s=new Map(t.import.flatMap((([e,n])=>{try{return[[t.restoreArgument(e),t.restoreResolution(n)]]}catch{return[]}})).map((([e,t])=>[e,{resolution:t,expiration:Date.now()+i}])));else{if(!Ie(t.import))throw"saved.import does not match any recognized format";s=new Map(t.import.data.flatMap((([e,n,i])=>{try{return[[t.restoreArgument(e),{resolution:t.restoreResolution(n),expiration:i}]]}catch{return[]}})))}else s=new Map;else s=new Map(t.data.map((([e,t,n])=>[e,{resolution:t,expiration:n}])));else s=new Map;const r=e=>n?.getCacheKey?.(e)??e,a=e=>n?.getCachedResolution?.(e)??{hit:!1,value:void 0},o=(e,t,i)=>n?.transformResolution?.(e,t,i,(e=>Oe(e,s)))??{resolution:t,expiration:i},c=(e,t)=>n?.cacheResolution?.(e,t);function l(e){{const t=a(e);if(t.hit)return t}{const t=Oe(e,s),n=Date.now();if(t.hit&&n<t.value.expiration){const i=o(e,t.value.resolution,t.value.expiration);if(n<i.expiration)return c(e,i),ke(i.resolution)}}return{hit:!1,value:void 0}}const d=Date.now();s.forEach((({resolution:e,expiration:t},n)=>{d<t?c(n,o(n,e,t)):s.delete(n)}));const u=new Map,h="cacheForMillis"in e?t=>e.fn(t).then((t=>new Te(t,{forMillis:e.cacheForMillis}))):e,p=e=>{const t=r(e);{const e=Oe(t,u);if(e.hit)return e.value;const n=l(t);if(n.hit)return Promise.resolve(n.value)}const n=h(e).then((({value:e,expiration:n})=>{const i=Date.now()<n,r=o(t,e,n);return i&&s.set(t,{resolution:e,expiration:n}),i&&c(t,r),r.resolution}));return u.set(t,n),n.finally((()=>u.delete(t))).catch((()=>{})),n};function f(e){return e?{version:2,data:Array.from(s.entries()).map((([t,{resolution:n,expiration:i}])=>[e.saveArgument(t),e.saveResolution(n),i]))}:{version:2,data:Array.from(s.entries()).map((([e,{resolution:t,expiration:n}])=>[e,t,n]))}}function g(e){return l(r(e))}return p.saveCache=f,p.checkCache=g,p}(e,t,{getCacheKey:e=>ve(e)[0],getCachedResolution:e=>{const t=Oe(e,i);return t.hit&&Date.now()<t.value.expiration?ke(t.value.resolution):{hit:!1,value:void 0}},transformResolution:(e,t,i,s)=>{(()=>{const t=s(e);return t.hit?c(e,t.value.resolution):[]})().forEach((t=>n.get(t)?.delete(e)));const r=new Set(c(e,t)),a=new Set;r.forEach((t=>{const i=n.get(t);if(i)i.add(e),i.forEach((e=>a.add(e)));else{const i=new Set([e]);n.set(t,i),a.add(e)}})),a.delete(e);const o=Date.now();return Array.from(a).reduce((({resolution:e,expiration:t},n)=>{const i=s(n);return i.hit&&o<i.value.expiration?(c(n,i.value.resolution).forEach((t=>e.add(t))),{resolution:e,expiration:Math.min(t,i.value.expiration)}):{resolution:e,expiration:t}}),{resolution:r,expiration:i});function c(e,t){const n=Array.from(t,(e=>ve(e)[0]));return n.push(e),n}},cacheResolution:(e,{resolution:t,expiration:n})=>t.forEach((e=>i.set(e,{resolution:t,expiration:n})))});return s}class Te{value;expiration=0;constructor(e,t){this.value=e,"object"==typeof t&&("until"in t?this.expiration=t.until.valueOf():"forMillis"in t&&(this.expiration=Date.now()+t.forMillis))}}function ke(e){return{hit:!0,value:e}}function Oe(e,t){return t.has(e)?ke(t.get(e)):{hit:!1,value:void 0}}function Ne(e){return`ISBNExportTool/0.3 (${e?e+"; ":""}+https://github.com/ChrisJohnsen/ISBN-Export-Tool)`}class Ae{throttles=new Map;set(e,t){const n=Ce(e),i=t.match(/^\s*(\d+)\s*$/),s=i?new Date(Date.now()+1e3*parseInt(i[1])):new Date(t);return this.throttles.set(n,s.valueOf()),s}shouldThrottle(e){const t=this.throttles.get(Ce(e));return void 0!==t&&Date.now()<t&&new Date(t)}}function Ce(e){const t=e.match(new RegExp("^https?://([^/]+)"));return t?t[1].toLowerCase():e}class xe{description;constructor(e){this.description=e}}async function _e(e,t,n,i){const[s,r]=t instanceof Te?[t,t.value]:[void 0,t],a=function(e,t){if("string"==typeof t)return t;const n=t.status,i=`${n}${t.statusText?` ${t.statusText}`:""}`;var s;return{temporary:`${e} ${500<=(s=n)&&s<600?"server error:":400<=s&&s<500?"client error:":300<=s&&s<400?"unfinished redirect:":200<=s&&s<300?"OK as error!?:":100<=s&&s<200?"interim as final!?:":"bad(?)"} HTTP status ${i}`}}(e,r);return("string"==typeof a?await i(a):new n(a)).expires(s?.expiration)}class Be{set=new Set;warnings=[];temporaryFaults=[];cacheUntil;constructor(e){e&&("warning"in e&&this.addWarning(e.warning),"temporary"in e&&this.addTemporaryFault(e.temporary))}addString(e){return this.set.add(e),this}addError(e,t){const n=e instanceof xe?e:new xe(e.toString());return t.push(n),this}asEditionsISBNResults(){const{warnings:e,temporaryFaults:t,cacheUntil:n}=this;return{isbns:this.set,warnings:e,temporaryFaults:t,cacheUntil:n}}absorbFaults(e){return this.warnings=this.warnings.concat(e.warnings),this.temporaryFaults=this.temporaryFaults.concat(e.temporaryFaults),this}addWarning(e){return this.addError(e,this.warnings)}addTemporaryFault(e){return this.addError(e,this.temporaryFaults)}expires(e){return void 0===e||(e instanceof Date&&(e=e.valueOf()),void 0===this.cacheUntil?this.cacheUntil=e:this.cacheUntil=Math.min(this.cacheUntil,e)),this}}class De extends Be{next;setNext(e){this.next=e}absorb(e){return e.set.forEach((e=>this.set.add(e))),this.absorbFaults(e),this.expires(e.cacheUntil),this}}const Me="https://openlibrary.org";function $e(e,t){return void 0===t?n:n(t);async function n(t){const n=await async function(e,t){const n=`/isbn/${t}.json`;return _e(n,await e(`${Me}${n}`),Be,(e=>async function(e,t){let n;try{n=JSON.parse(e)}catch{return new Be({temporary:`${t} response is not parseable as JSON`})}const i=oe({works:ie(ee())}),s=de(n,i,{errors:!0});if(s.errors)return new Be({temporary:`${t} malformed?: ${s.errors.join("; ")}`});const r=s.value;if(r.works.length<1)return new Be({temporary:`${t} response .works is empty`});const a=r.works.reduce(((e,n,i)=>{const s=de(n,oe({key:te()}),{errors:!0});if(s.errors)return e.addWarning(`${t}.works[${i}] malformed?: ${s.errors.join("; ")}`);const r=s.value.key,a="/works/";return r.startsWith(a)?e.addString(r.slice(a.length)):e.addWarning(`${t} response .works[${i}].key (${r}) does not start with ${a}`)}),new Be);return a.set.size<1?a.addTemporaryFault(`${t} has no valid workIDs`):a}(e,n)))}(e,t);if(n.set.size<1)return n.asEditionsISBNResults();const i=(await Promise.allSettled(Array.from(n.set).map((async t=>We(e,function(e){return`${Me}/works/${e}/editions.json`}(t)))))).reduce((function(e,t){return"fulfilled"==t.status?e.absorb(t.value):e.addTemporaryFault(t.reason.toString())}),(new De).expires(n.cacheUntil));if(i.absorbFaults(n),i.set.size<1){const e=new xe(`no valid ISBNs among all editions.jsons for all ${t} works`);return i.addTemporaryFault(e).asEditionsISBNResults()}return i.asEditionsISBNResults()}}async function We(e,t){return async function(e,t){const n=t.startsWith(Me)?t.slice(Me.length):t;return _e(n,await e(t),De,(e=>async function(e,t){let n;try{n=JSON.parse(e)}catch{return new De({temporary:`${t} response is not parseable as JSON`})}const i=new De;oe({links:oe({next:te()})})(n)&&(i.next=n.links.next);const s=oe({entries:ie(ee())}),r=de(n,s,{errors:!0});if(r.errors)return i.addTemporaryFault(`${t} malformed?: ${r.errors.join("; ")}`);return r.value.entries.reduce(((e,n,i)=>{const s=de(n,oe({isbn_10:ue(ie(te())),isbn_13:ue(ie(te()))}),{errors:!0});if(s.errors)return e.addWarning(`${t} .entries[${i}] malformed?: ${s.errors.join("; ")}`);const r=s.value,a=new De;return[...r.isbn_10??[],...r.isbn_13??[]].forEach((e=>a.addString(ye(e)))),a.set.size<1&&a.addWarning(`${t} .entries[${i}] has no ISBNs`),e.absorb(a)}),i)}(e,n)))}(e,t).then((t=>t.next?We(e,t.next).then((e=>t.absorb(e)),(e=>t.addTemporaryFault(e.toString()))):t),(e=>{throw e}))}const Fe="https://openlibrary.org";function Le(e,t){return void 0===t?n:n(t);async function n(t){const n=await async function(e,t){const n=`/search.json?q=${t}&fields=isbn`,i=`${Fe}${n}`;return _e(n,await e(i),De,(e=>async function(e,t){let n;try{n=JSON.parse(e)}catch{return new De({temporary:`${t} response is not parseable as JSON`})}const i=new De,s=oe({docs:ie(ee())}),r=de(n,s,{errors:!0});if(r.errors)return i.addTemporaryFault(`${t} malformed?: ${r.errors.join("; ")}`);return r.value.docs.reduce(((e,n,i)=>{const s=de(n,oe({isbn:ie(ee())}),{errors:!0});if(s.errors)return e.addWarning(`${t} .docs[${i}] malformed?: ${s.errors.join("; ")}`);const r=s.value,a=new De;return r.isbn.forEach(((e,n)=>{te()(e)?a.addString(ye(e)):a.addWarning(`${t} .docs[${i}].isbn[${n}] is not a string`)})),a.set.size<1&&a.addWarning(`${t} .docs[${i}] has no ISBNs`),e.absorb(a)}),i)}(e,n)))}(e,t);if(n.set.size<1){const e=new xe(`no valid ISBNs in search results for ${t}`);return n.addTemporaryFault(e).asEditionsISBNResults()}return n.asEditionsISBNResults()}}const Pe="https://www.librarything.com";function je(e,t){return void 0===t?n:n(t);async function n(t){const n=await async function(e,t){const n=`/api/thingISBN/${t}`,i=`${Pe}${n}`;return _e(n,await e(i),De,(e=>async function(e,t){return Array.from(e.matchAll(/<isbn>([^<]*)<\/isbn>/g)).map((e=>e[1])).reduce(((e,n)=>{const i=ye(n);return 0==i.length?e.addWarning(`${t} empty <isbn>`):e.addString(i)}),new De)}(e,n)))}(e,t);if(n.set.size<1){const e=new xe(`no valid ISBNs in search results for ${t}`);return n.addTemporaryFault(e).asEditionsISBNResults()}return n.asEditionsISBNResults()}}const Ue=ae({ETag:ue(te()),"Last-Modified":ue(te())}),He=ue(ae({content:te(),expires:ne()},{extra:Ue}));async function qe(e,t,n,i,s=(e=>e)){if(!Ge(i))return i;const{status:r,content:a,checkHeaders:o}=await e(t,i);return 200==r?{content:s(a),expires:Date.now()+n,...o}:304==r?i?{...i,expires:Date.now()+n}:void console.error("Got a 304, but had no previous value to make If-None-Match or If-Modified-Since"):(console.error(`HTTP status ${r} for ${t}`),i)}function Ge(e){return!e||e.expires<=Date.now()}const ze={format:"Goodreads",groupInfo:Ve((e=>Je("Shelf",tt(e).shelves))),rowsInGroup:Qe(((e,t)=>"Shelf"==e.kind&&function(e,t){const n=t=>tt(t).shelves.has(e);return void 0===t?n:n(t)}(e.name,t))),missingAndISBNs:Xe((function(e){return["ISBN13","ISBN"].flatMap((t=>{const n=e[t];return n?[n]:[]})).map((e=>e.replace(/^="(.*)"$/,"$1"))).filter((e=>""!=e))})),mainColumns:new Set(["Book Id","Title","Author","Exclusive Shelf","Bookshelves"])},Ye={format:"Goodreads",groupInfo:Ve((e=>Je("Collection",function(e){const t=e.Collections?nt(e.Collections):[];return new Set(t)}(e)).concat(Je("Tag",function(e){const t=e.Tags?nt(e.Tags):[];return new Set(t)}(e))))),rowsInGroup:Qe(((e,t)=>"Collection"==e.kind&&function(e,t){return!!t.Collections&&nt(t.Collections).includes(e)}(e.name,t)||"Tag"==e.kind&&function(e,t){return!!t.Tags&&nt(t.Tags).includes(e)}(e.name,t))),missingAndISBNs:Xe((function(e){const t=new Array;e.ISBN&&t.push(e.ISBN.replace(/^\s*\[(.*)\]\s*$/,"$1"));e.ISBNS&&t.push(...nt(e.ISBNS));return t.filter((e=>""!=e))})),mainColumns:new Set(["Book Id","Title","Primary Author","Secondary Author","Collections","Tags"])};function Ke(e){const t=function(e){const t=new Set;for(const n of e)Object.getOwnPropertyNames(n).forEach((e=>t.add(e)));return t}(e),n=e=>e.every((e=>t.has(e)));if(n(["Book Id","Title","Author","Exclusive Shelf","Bookshelves","ISBN","ISBN13"]))return ze;if(n(["Book Id","Title","Primary Author","Collections","Tags","ISBN","ISBNs"]))return Ye;throw`unrecognized format with columns: ${Array.from(t).join(", ")}`}function Je(e,t){return Array.from(t).map((t=>({name:t,kind:e})))}function Ve(e){return t=>{const n=new Map;for(const i of t)e(i).forEach((e=>{const t=(()=>{{const t=n.get(e.kind);if(t)return t}const t=new Map;return n.set(e.kind,t),t})(),i=t.get(e.name)??0;t.set(e.name,i+1)}));return n}}function Qe(e){return(t,n,i)=>{const s=new Array;for(const r of t)e({kind:n,name:i},r)&&s.push(r);return s}}function Xe(e){return t=>{const n=new Array,i=new Set;for(const s of t){const t=e(s);0==t.length?n.push(s):t.forEach((e=>i.add(ve(e)[0])))}return{missingISBN:n,isbns:i}}}async function Ze(e,t){return await async function(e,t,n,i,s,r){const a=Array.from(e),{editionsOfs:o,abortAll:c}=function(e,t,n,i,s,r){const a=we(e);let o;const c=new Promise(((e,t)=>o=()=>t("Limited call aborted")));c.catch((()=>{}));const l=fe({limit:1,interval:1e3,strict:!0}),d=fe({limit:1,interval:1e3,strict:!0}),u=[["Open Library WorkEditions",$e,l],["Open Library Search",Le,l],["LibraryThing ThingISBN",je,d]],h=i?u.filter((([e])=>i.has(e))):u,p={saveArgument:e=>e,saveResolution:Array.from},f={restoreArgument:e=>de(e,te(),{throw:!0}),restoreResolution:e=>new Set(de(e,ie(te()),{throw:!0}))},g=h.map((([e,i,o])=>{const l=it((([t])=>({event:"fetch started",service:e,url:t})),t,(([t],n,i)=>({event:"fetch finished",service:e,url:t,elapsed:i})),r),d=n?o(l):l,u=it((([t])=>({event:"service query started",service:e,isbn:t})),i(d),(([t],n)=>({event:"service query finished",service:e,isbn:t,isbns:n.isbns,warnings:n.warnings,faults:n.temporaryFaults})),r),h=async e=>{const t=await u(e),n={forMillis:864e5},i={forMillis:2592e6},s="number"==typeof t.cacheUntil?{until:new Date(t.cacheUntil)}:t.temporaryFaults.length>1?n:i;return new Te(t.isbns,s)},g=Ee(h,{import:s?.[e],...f}),m=e=>a(g,e),w=e=>Promise.race([m(e),c]),b=e=>w(e).catch((t=>{try{r?.({event:"rejection",reason:t})}catch{}return new Set([e])}));return{serviceName:e,checkCache:e=>g.checkCache(e),query:b,saveCache:()=>{s&&(s[e]=g.saveCache(p))}}}));return{editionsOfs:g,abortAll:()=>{a.clearQueue(),o(),l((()=>{})).abort(),d((()=>{})).abort()}}}(10,t,n,i,s,r);try{r?.({event:"abort fn",fn:c})}catch{}const l=e=>e[Math.trunc(Math.random()*e.length)],d=a.map((e=>({isbn:e,editionsOf:l(o)}))),{cachedISBNs:u,uncachedAssignments:h}=d.reduce(((e,t)=>{const{isbn:n,editionsOf:i}=t,s=i.checkCache(n);if(s.hit){try{r?.({event:"service cache hit",service:t.editionsOf.serviceName,isbn:n})}catch{}s.value.forEach((t=>e.cachedISBNs.add(t))),f(i.serviceName,n,e.cachedISBNs)}else e.uncachedAssignments.push(t);return e}),{cachedISBNs:new Set,uncachedAssignments:[]});try{const e=new Map,t=(e,t)=>{{const n=e.get(t);if(n)return n}const n=new Set;return e.set(t,n),n};h.forEach((({isbn:n,editionsOf:{serviceName:i}})=>{t(e,i).add(n)})),r?.({event:"query plan",plan:e})}catch{}const p=await Promise.allSettled(h.map((async({isbn:e,editionsOf:t})=>f(t.serviceName,e,await t.query(e)))));return c(),o.forEach((e=>e.saveCache())),p.reduce(((e,t)=>{if("fulfilled"==t.status)for(const n of t.value)e.add(n);else try{r?.({event:"rejection",reason:t.reason})}catch{}return e}),u);function f(e,t,n){return o.forEach((i=>{if(i.serviceName!=e){const e=i.checkCache(t);e.hit&&e.value.forEach((e=>n.add(e)))}})),n}}(e,t.fetcher,t.throttle??!0,t.services,t.cacheData,t.reporter)}function et(e){const t=new Set;for(const n of e)ve(n).forEach((e=>t.add(e)));return t}function tt(e){const t=e["Exclusive Shelf"],n=e.Bookshelves?e.Bookshelves.split(/\s*,\s*/):[],i=new Set(n);return t&&i.add(t),{exclusive:t,shelves:i}}function nt(e){return e.split(",").map((e=>e.trim()))}const it=(e,t,n,i)=>i?((e,t,n)=>(...i)=>{try{e(i)}catch{}const s=Date.now(),r=t(...i);return(async()=>{try{n(i,await r,Date.now()-s)}catch{}})(),r})((t=>i(e(t))),t,((e,t,s)=>i(n(e,t,s)))):t,st=Object.freeze(new Set(["Open Library WorkEditions","Open Library Search","LibraryThing ThingISBN"]));function rt(e){throw"assertNever called"}function at(e,t={}){return"string"==typeof e?{type:"text",title:e,...t}:{...e,...t}}function ot(e){const t=(()=>{if("text"==e.type){const t=UITableCell.text(e.title,e.subtitle);return e.titleFont&&(t.titleFont=e.titleFont),e.titleColor&&(t.titleColor=e.titleColor),t}if("button"==e.type){const t=UITableCell.button(e.title);return t.onTap=e.onTap,t}if("image"==e.type)return UITableCell.image(e.image);rt()})();return e.align&&t[`${e.align}Aligned`](),e.widthWeight&&(t.widthWeight=e.widthWeight),t}function ct(e){return{image:SFSymbol.named(e).image,width:{xmark:9,checkmark:9,"checkmark.square":9,square:9,questionmark:6,"questionmark.circle":8,"questionmark.square":9,"chevron.backward":6,"chevron.forward":6,"arrowtriangle.right.square.fill":9,"arrowtriangle.down.square.fill":9,magnifyingglass:9,"doc.on.clipboard":8,doc:7,gear:9}[e]??10}}function lt(e){const{image:t,width:n}=ct(e);return{type:"image",image:t,widthWeight:n}}class dt{constructor(e,t){this.table=e,this.title=t}addRow(e){const t=function(e){const t=new UITableRow;return e?.onSelect&&(t.onSelect=e.onSelect,t.dismissOnSelect=!1),e?.dismissOnSelect&&(t.dismissOnSelect=e.dismissOnSelect),e?.height&&(t.height=e.height),e?.cellSpacing&&(t.cellSpacing=e.cellSpacing),t}(e);return this.table.addRow(t),t}addHeightAdjuster(e,t=(()=>this.table.reload())){const n=n=>()=>{e.height+=n,t(e.height)},i=ot({type:"button",title:"-1",align:"left",onTap:n(-1)}),s=ot({type:"button",title:"-10",align:"left",onTap:n(-10)}),r=ot({type:"button",title:"show/set",align:"center",onTap:async()=>{const n=new Alert;n.title="Current Height",n.message=`The curret ehight is ${e.height}.\n\nEnter a new height:`;n.addTextField("new height",String(e.height)).setNumberPadKeyboard(),n.addCancelAction("Okay"),await n.presentAlert();const i=parseInt(n.textFieldValue(0));i>0&&(e.height=i,t(e.height))}}),a=ot({type:"button",title:"+10",align:"right",onTap:n(10)}),o=ot({type:"button",title:"+1",align:"right",onTap:n(1)});return this.addRowWithCells([i,s,r,a,o])}addRowWithCells(e,t){const n=this.addRow(t);return e.forEach((e=>n.addCell(e))),n}addTitleConfigRow(e){const t=new Array,n=lt("gear");return n.widthWeight=.75*n.widthWeight,e&&t.push(ot({type:"text",title:"",widthWeight:n.widthWeight})),t.push(ot({type:"text",title:this.title,align:"center",titleFont:Font.title2(),widthWeight:100-2*n.widthWeight})),e&&t.push(ot({...n,align:"right"})),this.addRowWithCells(t,{onSelect:e})}addSymbolExamples(){const e=e=>{const{image:t,width:n}=ct(e);console.log(e);const i=t.size.width;console.log(t.size),console.log(i/(n/100)),console.log({m:n,t:Math.trunc(i/1.911),r:Math.round(i/1.911)});const s=Device.screenSize().width*n/100;console.log(s/i);const r=[1,2,3,4,5,6,7,8,9,10].map((e=>({type:"image",image:t,widthWeight:e}))),a=r.reduce(((e,t)=>e+(t.widthWeight??0)),0);this.addRowWithDescribedCells([...r,{type:"text",title:"R",widthWeight:100-a}],{cellSpacing:0})};e("xmark"),e("checkmark"),e("checkmark.square"),e("square"),e("questionmark"),e("questionmark.circle"),e("questionmark.square"),e("chevron.backward"),e("chevron.forward"),e("arrowtriangle.right.square.fill"),e("arrowtriangle.down.square.fill"),e("magnifyingglass"),e("doc.on.clipboard"),e("doc"),e("gear")}addFontExamples(){["largeTitle","title1","title2","title3","headline","subheadline","body","callout","caption1","caption2","footnote"].forEach((e=>{this.addRowWithDescribedCells([{type:"text",title:e,titleFont:Font[e]()}])}))}addBackRow(e,t){const n=lt("chevron.backward"),i=ot({...n,align:"right"}),s=ot({type:"text",title:e,align:"left",widthWeight:100-n.widthWeight});return this.addRowWithCells([i,s],{onSelect:t})}addSubtitleHelpRow(e,t,n){const i=lt("questionmark.circle"),s=[];let r;return t&&(r=async()=>{const i=new Array;n&&Object.entries(n).forEach((([e,t])=>{e&&t&&i.push([e,t])})),i.push([e,t]);let s=e,r=t;for(;;){const t=new Alert;t.title=this.title+"\n"+e+"\n"+(s==e?"":s+"\n"),t.message=r;const n=i.filter((([e])=>e!=s));n.forEach((([e])=>{t.addAction(e+" Help")})),t.addCancelAction("Okay");const a=await t.presentSheet();if(-1==a)return;[s,r]=n[a]}}),r&&s.push(ot({type:"text",title:"",widthWeight:i.widthWeight})),s.push(ot({type:"text",title:e,align:"center",titleFont:Font.title2(),widthWeight:100-2*i.widthWeight})),r&&s.push(ot({...i,align:"right"})),this.addRowWithCells(s,{onSelect:r})}addEmptyRow(){return this.addRow()}addTextRow(e,t={}){const n=ot({type:"text",title:e});return this.addRowWithCells([n],t)}addIndentRow(e,t={}){const n=ot({type:"text",title:"",widthWeight:1}),i=ot({type:"text",title:e,widthWeight:9});return this.addRowWithCells([n,i],t)}addForwardRow(e,t,n=!1){const i=["xmark","chevron.forward"].map(lt),s=i[Number(!!t)];n&&(s.widthWeight=Math.max(...i.map((e=>e.widthWeight))));const r=ot({...s,align:"left"}),a=ot({...at(e),align:"right",widthWeight:100-s.widthWeight});return this.addRowWithCells([a,r],{onSelect:t})}addClosedDisclosureRow(e,t,n={}){const i=lt("arrowtriangle.right.square.fill"),s=ot({...i,align:"left"}),r=ot({type:"text",title:e,align:"left",widthWeight:45}),a=ot({type:"text",title:t,align:"right",widthWeight:55-i.widthWeight});return this.addRowWithCells([s,r,a],n)}addOpenedDisclosureRow(e,t={}){const n=lt("arrowtriangle.down.square.fill"),i=ot({...n,align:"left"}),s=ot({type:"text",title:e,align:"left",widthWeight:100-n.widthWeight});return this.addRowWithCells([i,s],t)}addCheckableRow(e,t,n={}){const i=ot((()=>{const e=lt("checkmark.square"),n=lt("square"),i=Math.max(e.widthWeight,n.widthWeight);if(void 0===t)return{type:"text",title:"",widthWeight:i};return{...t?e:n,align:"left",widthWeight:i}})()),s=ot({type:"text",title:e,align:"right",widthWeight:100-i.widthWeight});return this.addRowWithCells([s,i],n)}addRowWithDescribedCells(e,t={}){this.addRowWithCells(e.map(ot),t)}}var ut=[{name:"outdent",version:"0.8.0",license:"MIT",licenseText:'The MIT License (MIT)\n\nCopyright (c) 2016 Andrew Bradley\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the "Software"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n'},{name:"papaparse",version:"5.4.1",license:"MIT",licenseText:'The MIT License (MIT)\n\nCopyright (c) 2015 Matthew Holt\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of\nthis software and associated documentation files (the "Software"), to deal in\nthe Software without restriction, including without limitation the rights to\nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\nthe Software, and to permit persons to whom the Software is furnished to do so,\nsubject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS\nFOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR\nCOPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER\nIN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN\nCONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n'},{name:"isbn3",version:"1.1.35",license:"MIT",licenseText:null},{name:"typanion",version:"3.12.1",license:"MIT",licenseText:null},{name:"p-throttle",version:"5.0.0",license:"MIT",licenseText:'MIT License\n\nCopyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n'},{name:"yocto-queue",version:"1.0.0",license:"MIT",licenseText:'MIT License\n\nCopyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n'},{name:"p-limit",version:"4.0.0",license:"MIT",licenseText:'MIT License\n\nCopyright (c) Sindre Sorhus <sindresorhus@gmail.com> (https://sindresorhus.com)\n\nPermission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n'}];const ht=v({newline:"\n"});function pt(e){const t=e.constructor;if(!t)return`< ${typeof e}?!? >`;const n=t.title;return"string"==typeof n?n:`< ${t.name} >`}class ft{constructor(e,t){this.back=e,this.previous=t}static title="Configuration";hideConfig=!0;justUpdated=!1;async build(e,t,n){if(this.justUpdated)return void e.addTextRow("Update installed. Will restart in 5 seconds.");e.addBackRow(pt(this.back),(()=>t(this.back))),e.addEmptyRow(),e.addTextRow("Network Access Permissions"),e.addForwardRow("Get Other Editions",(()=>t(At.editionsOf(this.previous).uiState(this))));const i=At.updates(this.previous);e.addForwardRow("Updates",(()=>t(i.uiState(this)))),e.addEmptyRow(),e.addForwardRow("check for updates now",(async()=>{if(await n.requestUpdateCheck(!0))await mt(i,n)&&(this.justUpdated=!0,t(this));else{const e=new Alert;e.title="No Update Available",e.message="No update for this program is currently available.",e.addCancelAction("Okay"),e.presentAlert()}})),e.addEmptyRow(),e.addTextRow("Acknowledgeable Warnings"),e.addForwardRow("Get Other Editions is slow",(()=>t(new Ot(this.back,this.previous)))),e.addEmptyRow(),e.addTextRow("Other Settings"),e.addForwardRow("debug-only stuff",(()=>n.debugUI().then((()=>t(this))))),e.addEmptyRow(),e.addForwardRow("Copyrights",(()=>t(new gt(this))))}}class gt{constructor(e){this.back=e}static title="Copyrights";hideConfig=!0;async build(e,t){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addTextRow("tap a row for full license text"),e.addEmptyRow();const n=(t,n,i,s)=>e.addRowWithDescribedCells([{...at(t),align:"left",widthWeight:2},{...at(n),align:"center",widthWeight:1},{...at(i),align:"right",widthWeight:1}],{onSelect:s?async()=>{const e=new Alert;e.title=t+" License",e.message=s,e.addCancelAction("Okay"),await e.presentAlert()}:void 0});n("Included Dependency","Version","License",""),ut.forEach((e=>n(e.name??"",e.version??"",e.license??"",e.licenseText??"")))}}async function mt(e,t){const n=new Alert;n.title="Install Update?",n.message="An updated version of this program is ready to be installed.\n\nAutomatic checks for updates can be disabled in the configuration settings (gear icon on the title row).\n\nDo you want to install this update now?\nBefore the update can be launched, you will need to exit the current session, and close the JavaScript code view if it is open.",n.addAction("Yes"),n.addCancelAction("Not now"),n.addAction("Never");const i=await n.presentAlert();return-1!=i&&(0==i?await t.requestUpdateInstall():1==i&&(e.set(!1),t.clearPendingUpdate(),!1))}class wt{constructor(e){this.previous=e}static title="Starting…";hideConfig=!0;justUpdated=!1;async build(e,t,n){const i=()=>t(new bt(this.previous)),s=e=>{Timer.schedule(0,!1,e)};if(Date.now()<this.firstRun()+6048e5)return s(i);if(this.justUpdated)return void e.addTextRow("Update installed. Will restart in 5 seconds.");e.addSubtitleHelpRow(pt(this));const r=At.updates(this.previous),a=n.updateStatus();return"dormant"==a?s(i):"pending"==a?(e.addTextRow("An update is ready for installation."),s((async()=>{await mt(r,n)?(this.justUpdated=!0,t(this)):i()}))):"expired"==a?r.denied()?s(i):(e.addTextRow("Checking for update (up to 10 seconds)…"),s((async()=>{await r.askAllowed(!0)&&await Promise.race([n.requestUpdateCheck(),new Promise((e=>Timer.schedule(1e4,!1,(()=>e(!1)))))])&&"pending"==n.updateStatus()?t(this):i()}))):void rt()}firstRun(){return void 0===this.previous.firstRun&&(this.previous.firstRun=Date.now()),this.previous.firstRun}}class bt{constructor(e,t){this.previous=e,this.previousInput=t}static title="Input Selection";async build(e,t,n){e.addSubtitleHelpRow(pt(this),ht`
      This program reads exported book list data to let you access the ISBNs of your listed items.

      You can review the items that are missing ISBNs, and view or save the list of ISBNs (optionally including ISBNs of other editions of the listed book).

      Some libraries can import such an ISBN list and use it to show which of those books they have available in their holdings (e.g. which of your "To Be Read" list is available for checkout).

      These book list export formats are currently supported:
      - Goodreads export (CSV with a specific set of columns) and its Shelves
      - LibraryThing TSV export and its Collections and Tags
      Suggest your favorite book list format for support in future versions!

      When you have your data ready, tell us where to find it using the selections on this Input Selection screen.
    `,{"Goodreads Export":ht`
      Exporting from Goodreads can be done on the Goodreads website:


      Login.

      If on a mobile device, tap/click the "Desktop version" link in the footer of the website.

      Tap/click on the "My Books" tab.

      In the left sidebar, find the "Tools" section and tap/click on "Import and Export" link.

      On the Import/Export page tap/click the "Export Library" button at the top of the page.

      A link like "Your export from <date>" will appear when the export is ready.


      Once the export is ready, you can download the file (it will be in the Files app in your Downloads folder), or view the data in your web browser and use Select All and Copy to copy it to the clipboard.
    `,"LibraryThing Export":ht`
      Exporting from LibraryThing can be done on the LibraryThing website:


      Login.

      Tap/click the "More" top tab (inside three-horizontal-lines ("hamburger" menu) in the mobile view).

      In the "Useful and Fun" section, tap/click the "Import/Export" link.

      In the "Export from LibraryThing" section, tap/click the "Export as tab-delimited text" link.

      Tap/click the "Export all books" button, or fill out a filter and tap/click the "Export filtered" button.

      A "Download" button will appear when the export is ready.


      Once the export is ready, you can download the file (it will be in the Files app in your Downloads folder), or view the data in your web browser and use Select All and Copy to copy it to the clipboard.
    `}),e.addEmptyRow(),e.addTextRow("Where is your export data?"),e.addEmptyRow();const i=e=>{this.previousInput=e,t(new yt(this,this.previous,e))};if(this.previousInput){const t=this.previousInput;e.addForwardRow(at("already loaded",{titleColor:Color.orange()}),(()=>i(t)))}e.addForwardRow("On the clipboard",(()=>n.requestInput({type:"clipboard"}).then(i))),e.addForwardRow("In a saved or downloaded file",(()=>n.requestInput({type:"file"}).then(i)))}}class yt{constructor(e,t,n){this.back=e,this.previous=t,this.input=n}static title="Item Selection";async build(e,t,n){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      Start by selecting which items from the exported data we will examine. The next step will check the selection for items that are missing ISBNs.

      Currently only a whole groups of items (shelves, collections, tags) can be selected. On this screen, choose the group that holds the items you want to examine.
    `),e.addEmptyRow(),e.addTextRow(`Found ${this.input.items} items in export data.`),e.addTextRow("Choose the group to examine.");const i=async(e,i)=>{this.previous.group={kind:e,name:i},t(new St(this,this.previous,{input:this.input,group:{kind:e,name:i},summary:await n.requestGroup(e,i)}))},s=this.input.groupItems,r=(t,n,i,s,r=!1)=>e.addRowWithDescribedCells([{type:"text",title:t,widthWeight:30,align:"left"},{type:"text",title:n,widthWeight:55,align:"right",titleColor:r?Color.orange():void 0},{type:"text",title:i,widthWeight:15,align:"left"}],{onSelect:s,cellSpacing:10});r("Kind","Group","Items"),Object.entries(s).forEach((([e,t])=>Object.getOwnPropertyNames(t).forEach((t=>r(e,t,String(s[e]?.[t]),(()=>i(e,t)),e==this.previous.group?.kind&&t==this.previous.group.name)))))}}function vt(e,t,n){e.addTextRow("Output Options"),n?.();const i=lt("magnifyingglass"),s=lt("doc.on.clipboard"),r=lt("doc"),a=Math.max(...[i,s,r].map((e=>e.widthWeight)));[i,s,r].forEach((e=>e.widthWeight=a));const o=(t,n,i)=>{const s=100-n.widthWeight;e.addRowWithDescribedCells([{type:"text",title:t,align:"right",widthWeight:s},{...n,align:"center"}],{onSelect:i})};o("View",i,(()=>t({type:"view"}))),o("Copy to the clipboard",s,(()=>t({type:"clipboard"}))),o("Save to a file",r,(()=>t({type:"file"})))}class St{constructor(e,t,n){this.back=e,this.previous=t,this.igs=n}static title="Item Summary";async build(e,t,n){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      The bulk of this program works only with ISBNs, so any item that lacks an ISBN can not be usefully processed beyond pointing out the missing ISBN.

      Items missing an ISBN often occur because the default edition is an eBook or audiobook version that happens to not use an ISBN. If you did not mean to specifically select that non-ISBN edition you can usually change the listing (e.g. Goodread's Book Details) to an ISBN-bearing edition so that (in a future data export) its ISBN can be used by the rest of this program.

      Every item from the provided data that does not have an ISBN is in the "Items Missing an ISBN" list. Likewise, every item that has an ISBN will contribute it to the "Item ISBNs" list.

      Each category can be viewed or saved by selecting its view/save option.

      You can use the "Select Editions Services" option to extend the list of ISBNs with those of other editions of the same work. See the help on that screen for more information.
    `),e.addEmptyRow();const i=this.igs.group,s=this.igs.input.groupItems[i.kind]?.[i.name]??0,r=this.igs.summary;e.addTextRow(`${s} items in selection (${i.kind} ${i.name}).`),e.addTextRow(`${r.missingISBNCount} items with no ISBN.`),e.addForwardRow("View/Save Items Missing an ISBN",(()=>t(new It(this,this.igs)))),e.addTextRow(`${r.isbnCount} items with an ISBN.`),e.addForwardRow("View/Save Item ISBNs",(()=>t(new Rt(this,this.previous,this.igs)))),e.addEmptyRow(),e.addTextRow("Want to also include the ISBNs of other editions of the extracted item ISBNs?",{height:88});const a=At.editionsOf(this.previous);e.addForwardRow("Select Editions Services",a.denied()?void 0:async()=>{if(0==await a.askAllowed()){const e=new Alert;return e.title="Network Access Disallowed!",e.message="We will not be able to get other edition ISBNs without your permission to access the Internet.\n\nWe need be able to:\n ① ask whether any of the editions services should be disabled, and\n ② send your selected ISBNs to the editions services to ask them for the ISBNs of other editions.",e.addCancelAction("Okay"),void await e.presentAlert()}t(new Et(this,this.previous,this.igs,await n.requestEditionsServices()))}),a.denied()&&e.addIndentRow("Network Access must not be disallowed before we can proceed.",{height:88}),a.addRow(this,e,t)}}class It{constructor(e,t){this.back=e,this.igs=t}static title="Items Missing an ISBN";async build(e,t,n){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),"Select an Output Option to view or save the full output."),e.addEmptyRow();const i=this.igs.group,s=this.igs.input.groupItems[i.kind]?.[i.name]??0;e.addTextRow(`${s} items in selection (${i.kind} ${i.name}).`),e.addTextRow(`${this.igs.summary.missingISBNCount} items with no ISBN.`),vt(e,(e=>n.requestOutputMissing(e).then((()=>t(this.back)))))}}class Rt{constructor(e,t,n){this.back=e,this.previous=t,this.igs=n}static title="Item ISBNs";async build(e,t,n){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      Select an Output Option to view or save the full output.

      Only the ISBN-13 version of each ISBN is provided by default. Select the "Include both" option to also include the ISBN-10 version when possible (not all ISBNs have an old-style ISBN-10 version).
    `),e.addEmptyRow();const i=this.igs.group,s=this.igs.input.groupItems[i.kind]?.[i.name]??0,r=this.previous.both??!1,a=()=>{this.previous.both=!r,t(this)};e.addTextRow(`${s} items in selection (${i.kind} ${i.name}).`),e.addTextRow(`${this.igs.summary.isbnCount} items with an ISBN.`),vt(e,(e=>n.requestOutputISBNs(r,e).then((()=>t(this.back)))),(()=>e.addCheckableRow("Include both ISBN-10 and ISBN-13?",r,{onSelect:a})))}}class Et{constructor(e,t,n,i){this.back=e,this.previous=t,this.igs=n,this.availableServices=i}static title="Select Editions Services";async build(e,t,n){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      Books often have multiple editions, and thus multiple ISBNs. Some book lists only let you add one edition of a book, so the data will only include (at most) one ISBN for each book.

      If you are interested in finding any edition of the books in your lists, then it might be handy to be able to gather not just the ISBN of the (sometimes arbitrary) edition in your list, but also the ISBNs of other editions of that book.

      Some book-data websites offer a way to find the ISBNs of other editions of a book (at least the editions that those services know about). We can use those services to gather those extra ISBNs.

      Requests to these services are limited to one per second, so it may take some time to process a large list. We save the results for re-use though, so later queries about the same book should be faster.
    `),e.addEmptyRow();const i=this.previous.services??new Set(this.availableServices),s=e=>{const n=new Set(i);n.has(e)?n.delete(e):n.add(e),this.previous.services=n,t(this)};if(this.availableServices.forEach((t=>e.addCheckableRow(t,i.has(t),{onSelect:()=>s(t)}))),e.addEmptyRow(),i.size>0){const s=this.igs.summary.isbnCount;e.addForwardRow("Get Other Editions",(async()=>{const e=new WebView;await e.loadHTML("");if(!await e.evaluateJavaScript("navigator.onLine")){const e=new Alert;return e.title="Device Offline?",e.message='This device appears to be offline.\n\nPlease make sure you have an Internet connection before using "Get Other Editions".',e.addCancelAction("Okay"),void await e.presentAlert()}await async function(e,t){if(e.editionsSlowOkay)return!0;const n=new Alert;n.title="Getting Editions May Take Some Time",n.message=ht`
      ${Tt}

      This could be up to ${t} seconds for the selected items.

      ${kt}
    `,n.addAction("I will wait; do not tell me again."),n.addAction("I will wait."),n.addCancelAction("That is too long to wait!");const i=await n.presentAlert();if(0==i)return e.editionsSlowOkay=!0,!0;if(1==i)return!0;return!1}(this.previous,s)&&t(new _t(this,this.previous,this.igs,await n.requestEditions(Array.from(i),(e=>this.editionsProgress(t,e)))))}),!0),e.addBackRow(pt(this.back),(()=>t(this.back)))}else e.addForwardRow("Get Other Editions",void 0,!0),i.size<=0&&e.addIndentRow("One or more editions services must be selected before we can proceed.",{height:88})}progressState;editionsProgress(e,t){this.progressState?(this.progressState.progress(t),e(this.progressState)):(this.progressState=new xt(this,this.igs.group,t),e(this.progressState))}}const Tt="Due to using external services, we limit how quickly we issue queries for other edition ISBNs. It will take approximately one second per queried ISBN to finish.",kt="We save the query results for later re-use, so subsequent runs will be faster (assuming some recurring ISBNs).";class Ot{constructor(e,t){this.back=e,this.previous=t}static title='"Get Other Editions" Is Slow';hideConfig=!0;async build(e,t){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),'You can select the "do not warn me" option here to skip the warning.'),e.addEmptyRow(),e.addTextRow(Tt,{height:132}),e.addTextRow(kt,{height:88}),e.addEmptyRow(),e.addTextRow("Do you want to be warned every time about this?");const n=e=>{this.previous.editionsSlowOkay=e,t(this)},i=this.previous.editionsSlowOkay;e.addCheckableRow("Yes, warn me every time.",!i,{onSelect:()=>n(void 0)}),e.addCheckableRow("No, do not warn me.",!!i,{onSelect:()=>n(!0)})}}class Nt{constructor(e,t){this.previous=e,this.key=t}get netPermission(){return this.previous[this.key]}set netPermission(e){this.previous[this.key]=e}denied(){return 0==this.netPermission}}class At{constructor(e,t,n,i,s){this.actionText=n,this.text=i,this.height=s,this.previous=new Nt(e,t)}static editionsOf(e){return new At(e,"editionsNetwork","get ISBNs of other editions","Before we can ask about other editions of books, we need to know if any of the services we normally use have become unavailable.\n\n❗ No personal information will be sent for this purpose, we will only request a list of affected services.\n\n\nThen, to get the ISBNs of other editions, we will send your selected ISBNs to external services (Open Library and/or LibraryThing as per your selection).\n\n❗ Only ISBNs of your selected items will be sent. No other information, personal or otherwise will be sent.",352)}static updates(e){return new At(e,"updatesNetwork","check for updates","We can periodically check for updates to this program.\n\n❗ No personal information will be sent for this purpose, we will only request the most recent version of this program.",132)}previous;denied(){return this.previous.denied()}set(e){this.previous.netPermission=e}uiState(e){return new Ct(e,this.previous,this.actionText,this.text,this.height)}addRow(e,t,n){const i=this.previous.netPermission,s=1==i?"granted":0==i?"denied":"will ask";t.addForwardRow({type:"text",title:"Network Access: "+s,titleColor:"denied"==s?Color.red():void 0},(()=>n(this.uiState(e))))}async askAllowed(e=!1){const t=this.previous.netPermission;if("boolean"==typeof t)return t;const n=new Alert;n.title="Allow Network Access?";const i=e?"Use the gear icon on the title to control the default permission.":"Use the Network Access item (or the gear icon on the title) to control the default permission.";n.message=this.text+"\n\n"+i+"\n\nDo you want to allow this program to use the Internet to "+this.actionText+"?",n.addAction("Yes, use the Internet"),n.addCancelAction("No, do not use the Internet");const s=await n.presentAlert();return-1!=s&&0==s}}class Ct{constructor(e,t,n,i,s){this.back=e,this.previous=t,this.actionText=n,this.text=i,this.height=s}static title="Network Access";hideConfig=!0;async build(e,t){e.addBackRow(pt(this.back),(()=>t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      Some portions of this program need to access the Internet, however it will never access any network without your permission.

      By default, this program will ask for your permission each time it needs to access the Internet.

      You can use this screen to grant permission (allow access without asking), reserve permission (the default: ask each time), or deny permission (deny access without asking).

      You can change these settings at any time.
    `),e.addEmptyRow(),e.addTextRow(this.text,{height:this.height}),e.addTextRow(`Would you like to grant, reserve, or deny permission to access the Internet to ${this.actionText}?`,{height:88});const n=this.previous.netPermission,i=e=>{this.previous.netPermission=e,t(this)};e.addCheckableRow("Grant permission: Always allow.",1==n,{onSelect:()=>i(!0)}),e.addCheckableRow("Reserve permission: Ask each time.",null==n,{onSelect:()=>i(void 0)}),e.addCheckableRow("Deny permission: Never allow.",0==n,{onSelect:()=>i(!1)})}}class xt{constructor(e,t,n){this.back=e,this.group=t,this.editionsProgress=n}static title="Other Editions Progress";async build(e,t,n){e.addBackRow("Cancel Other Editions",(async()=>{const e=new Alert;e.title="Cancel Other Editions?",e.message="Normal operation will take approximately one second per query to finish.",e.addAction("Yes: Stop making queries!"),e.addCancelAction("No: I will wait.");-1!=await e.presentAlert()&&(await n.requestCancelEditions(),t(this.back))})),e.addSubtitleHelpRow(pt(this)),e.addEmptyRow(),e.addTextRow(`Retrieving ISBNs of other editions of ISBN-bearing items on ${this.group.kind} ${this.group.name}.`,{height:88});const{total:i,started:s,done:r,fetched:a}=this.editionsProgress,o=i-s,c=s-r;e.addTextRow("Queries:"),e.addIndentRow(`${r} done + ${c} active + ${o} waiting = ${i}`),e.addTextRow("Fetches:"),e.addIndentRow(`${a}`)}progress(e){this.editionsProgress=e}}class _t{constructor(e,t,n,i){this.back=e,this.previous=t,this.igs=n,this.editionsSummary={...i,received:Date.now()}}static title="Other Editions Summary";editionsSummary;async build(e,t,n){const{isbns:i,editionsServicesSummary:s,received:r}=this.editionsSummary,a=async()=>{if(!(Date.now()-r<5e3))return!0;const e=new Alert;return e.title="Leaving So Soon?",e.message="Other Editions just finished a few seconds ago.\n\nPlease confirm that you want to abandon these results and go back.",e.addAction("Abandon these results and go back now."),e.addCancelAction("Do not go back yet."),-1!=await e.presentAlert()};e.addBackRow(pt(this.back),(async()=>await a()&&t(this.back))),e.addSubtitleHelpRow(pt(this),ht`
      The ISBNs of other editions of your selected items have been retrieved. The queries are summarized on this screen.

      Select an Output Option to view or save the full list of ISBNs.

      Only the ISBN-13 version of each ISBN is provided by default. Select the "Include both" option to also include the ISBN-10 version when possible (not all ISBNs have an old-style ISBN-10 version).

      The "back" option at the bottom jumps back to the input selection screen (also available through multiple taps on "back" at the top).
    `),e.addEmptyRow();const o=this.igs.group,c=this.igs.input.groupItems[o.kind]?.[o.name]??0;e.addTextRow(`${c} items in selection (${o.kind} ${o.name}).`),e.addTextRow(`${this.igs.summary.isbnCount} items with an ISBN.`),e.addTextRow(`${i} total ISBNs after retrieving ISBNs of other editions.`,{height:88}),e.addEmptyRow();const l=Object.entries(s).reduce(((e,[,t])=>e+(t?.cacheHits??0)),0);0!=l&&e.addTextRow(`Reused ${l} Other Editions query results.`),Object.entries(s).forEach((([t,n])=>{n&&(e.addTextRow(`${t}`),e.addIndentRow((0!=n.cacheHits?`${n.cacheHits} reused results, `:"")+`${n.queries} new queries`),0!=n.fetches&&(e.addIndentRow(`${n.fetches} fetches ${n.fetchRate.toFixed(3)}/s`),e.addIndentRow(`${n.fetchStats.min}/${n.fetchStats.median}/${n.fetchStats.max} (ms min/median/max)`)))})),e.addEmptyRow();const d=()=>{this.previous.both=!this.previous.both,t(this)};vt(e,(e=>n.requestOutputEditionsISBNs(!!this.previous.both,e)),(()=>e.addCheckableRow("Include both ISBN-10 and ISBN-13?",!!this.previous.both,{onSelect:d}))),e.addEmptyRow(),e.addBackRow("Choose New Input",(async()=>await a()&&t(new bt(this.previous,this.igs.input))))}}var Bt="v0.3-0-g05b5122";const Dt=function(e){const t=new Ae;return async n=>{const i=t.shouldThrottle(n);if(0!=i)return new Te({status:429,statusText:"server requested throttling until "+i.toUTCString()},{until:i});const s=await e(n);if("string"==typeof s)return s;const{status:r,statusText:a,retryAfter:o}=s;if(429==r||503==r){const e=o?t.set(n,o):t.set(n,"600");return new Te({status:r,statusText:a},{until:e})}return{status:r,statusText:a}}}((async e=>{const t=new Request(e);t.headers={"User-Agent":Ne("Scriptable")};const n=await t.loadString(),i="number"==typeof(s=t.response.statusCode)?s:parseInt(s,10);var s;if(200<=i&&i<300)return n;const r=new Map(Object.entries(t.response.headers).map((([e,t])=>[e.toLowerCase(),t]))).get("retry-after");return"string"==typeof r?{status:i,statusText:"",retryAfter:r}:{status:i,statusText:""}}));async function Mt(e){{const e=e=>Math.trunc(Math.random()*e);await new Promise((t=>Timer.schedule(1*e(200)+200,!1,t)))}const t=e.match(/[?&]q=([ -\dxX]*)/);if(t){const e=ve(t[1]);return JSON.stringify({docs:[{isbn:[`${e[0]}-1234`,...e.length>1?[`${e[1]}-5678`]:[]]}]})}const n=e.match(/\/isbn\/(.*)\.json$/);if(n)return JSON.stringify({works:[{key:`/works/OL${ve(n[1])[0]}W`}]});const i=e.match(/\/works\/OL(.*)W\/editions\.json$/);if(i){const e=ve(i[1]);return JSON.stringify({entries:[{isbn_13:[`${e[0]}-1234`],...e.length>1?{isbn_10:[`${e[1]}-5678`]}:{}}]})}const s=e.match(/thingISBN\/(.*)$/);if(s){const e=ve(s[1]);return`<idlist>${[`${e[0]}-1234`,...e.length>1?[`${e[1]}-5678`]:[]].map((e=>`<isbn>${e}</isbn>`)).join("")}</idlist>`}throw`nope: ${e}`}async function $t(e,t){const n=new Request(e),i={};i["User-Agent"]=Ne("Scriptable"),t&&(t.ETag?i["If-None-Match"]=t.ETag:t["Last-Modified"]&&(i["If-Modified-Since"]=t["Last-Modified"])),n.headers=i;const s=await n.loadString();var r;return{status:"number"==typeof(r=n.response.statusCode)?r:parseInt(r),content:s,checkHeaders:(e=>{const t=new Map(Object.entries(e).filter((e=>"string"==typeof e[1])).map((([e,t])=>[e.toLowerCase(),t])));return{ETag:t.get("ETag".toLowerCase()),"Last-Modified":t.get("Last-Modified".toLowerCase())}})(n.response.headers)}}globalThis.setTimeout=(e,t,...n)=>{if("string"==typeof e)throw"setTimeout with uncompiled code argument not supported";return Timer.schedule(t,!1,(()=>e(...n)))},globalThis.clearTimeout=e=>e.invalidate();const Wt=new s(i(module.filename,"json"));if(await Wt.read(),Wt.data||(Wt.data={}),!e(Wt.data))throw"restored data is not an object?";if(Wt.data.UITableUIData||(Wt.data.UITableUIData={}),!e(Wt.data.UITableUIData))throw"restored UI data is not an object?";if(Wt.data.webcheckData||(Wt.data.webcheckData={}),!e(Wt.data.webcheckData))throw"restored UI data is not an object?";const Ft=()=>Wt.write(),Lt=i(module.filename,"log"),Pt=i(module.filename,"log",(e=>e+" test")),jt=i(module.filename,"json",(e=>e+" cache")),Ut=i(module.filename,"json",(e=>e+" test cache")),Ht=new class{constructor(e,t,n,i){this.logPathnamer=e,this.cachePathnamer=t,this.webcheckData=n,this.saveData=i,this.disabledEditionsServices=new Set(["Open Library WorkEditions"])}disabledEditionsServices;enableEditionsService(e,t=!0){t?this.disabledEditionsServices.delete(e):this.disabledEditionsServices.add(e)}testMode=!1;async debugUI(){const e=new UITable;e.showSeparators=!0;const t=new dt(e,"Debug UI"),n=(i=!0)=>{i&&e.removeAllRows(),t.addTextRow("Version: 0.3"),t.addTextRow(`Git: ${Bt}`),t.addTextRow("Production Mode"),t.addEmptyRow(),t.addRowWithDescribedCells([{type:"text",title:"Test Mode?",align:"left"},{type:"text",title:String(this.testMode),align:"right"}],{onSelect:()=>{this.testMode=!this.testMode,n()}}),t.addIndentRow('Test Mode makes the following changes:\n1. The GetISBNs "Editions Of" cache is switched to a test-only location.\n2. The GetISBNs "Editions Of" services will not make actual network requests and instead return fake data.',{height:149});const s=this.disabledEditionsServices.has("Open Library WorkEditions")?"disabled":"enabled",r=()=>this.enableEditionsService("Open Library WorkEditions",!this.disabledEditionsServices.has("Open Library WorkEditions"));t.addRowWithDescribedCells([{type:"text",title:"OL:WE status",align:"left"},{type:"text",title:s,align:"right"}],{onSelect:()=>{r(),n()}}),t.addIndentRow("OL:WE requires 1+N fetches/ISBN (throttled to 1 fetch/second) and probably gives the same results as OL:S (which needs only 1 fetch/ISBN).",{height:132}),i&&e.reload()};n(!1),await e.present(!1)}get pendingUpdate(){const e=this.webcheckData.updateContent;if("string"==typeof e)return e;this.webcheckData.updateContent=void 0}set pendingUpdate(e){this.webcheckData.updateContent=e}get updatesData(){const e=this.webcheckData.updatesData;if(He(e))return e;this.webcheckData.updatesData=void 0}set updatesData(e){this.webcheckData.updatesData=e}updateStatus(){return Ge(this.updatesData)?"expired":this.pendingUpdate?"pending":"dormant"}async requestUpdateCheck(e=!1){const t=this.updatesData;return e&&t&&(t.expires=Date.now()-1e3),this.updatesData=await qe($t,"https://raw.githubusercontent.com/ChrisJohnsen/ISBN-Export-Tool/released/Scriptable/ISBN%20Tool.js",2592e6,t,(e=>{const t=e.match(/\bgit: (\S+)/)?.[1]??"<no description found>";return this.pendingUpdate=e&&t!=Bt?e:void 0,t})),!!this.pendingUpdate}async requestUpdateInstall(){return!!this.pendingUpdate&&(FileManager.local().writeString(module.filename,this.pendingUpdate),this.pendingUpdate=void 0,await this.saveData(),Timer.schedule(5e3,!1,(()=>Safari.open(URLScheme.forRunningScript()))),!0)}clearPendingUpdate(){this.pendingUpdate=void 0}allRows=[];format;async requestInput(e){const{rows:t,format:i,input:s}=await async function(){const t=e.type;if("clipboard"==t){const e=Pasteboard.pasteString();if(null!=e){const{rows:n,format:i}=await r(e);return{rows:n,format:i,input:{type:t,...await o(i,n)}}}const n=new Alert;throw n.title="Clipboard Empty",n.message="No string value was available from the clipboard. Please Copy the CSV data to the clipboard before selecting this option.",await n.presentAlert(),"no string available from Pasteboard"}if("file"==t){const e=await DocumentPicker.openFile(),i=await new a(e).readString(),{rows:s,format:c}=await r(i);return{rows:s,format:c,input:{type:t,displayName:n(e),...await o(c,s)}}}rt();throw`unhandled input request type: ${t}`}();return this.allRows=t,this.format=i,s;async function r(e){try{const t=await be(e);return{rows:t,format:Ke(t)}}catch(e){console.error(e);const t=new Alert;throw t.title="Error Parsing Input",t.message="Are you sure that was a CSV data export?",await t.presentAlert(),e}}async function o(e,t){const n=e.groupInfo(t),i=Object.fromEntries(Array.from(n.entries()).map((([e,t])=>[e,Object.fromEntries(Array.from(t.entries()).sort(((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:e[1]-t[1])))])).sort(((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:0)));return{items:t.length,groupItems:i}}}selected;async requestGroup(e,t){if(!this.format)throw"requested group before format established";const{missingISBN:n,isbns:i}=this.format.missingAndISBNs(this.format.rowsInGroup(this.allRows,e,t));return this.selected={group:{kind:e,name:t},missingRows:n,isbns:i},{missingISBNCount:n.length,isbnCount:i.size}}async requestOutputMissing(e){if(!this.format)throw"requested output before format established";if(!this.selected)throw"requested output before anything selected";const t=`ISBNS missing in ${this.selected.group.kind} ${this.selected.group.name}.csv`,n=(i=this.selected.missingRows.map((s=Array.from(this.format.mainColumns),e=>s.reduce(((t,n)=>(n in e&&(t[n]=e[n]),t)),Object.create(null)))),Array.isArray(i)?O(i):O({fields:i.header,data:i.rows}));var i,s;return this.output(e,t,n)}async requestOutputISBNs(e,t){if(!this.selected)throw"requested output before anything selected";const n=`ISBNs on ${this.selected.group.kind} ${this.selected.group.name}.txt`,i=e?et(this.selected.isbns):this.selected.isbns,s=Array.from(i).join("\n");return this.output(t,n,s)}async output(e,i,s){const r=e.type;if("view"==r){const e=function(e,n){const i=new a(t.joinPath(t.temporaryDirectory(),e));return null!=n&&("string"==typeof n?i.writeString(n):i.write(n)),i}(i,s);await QuickLook.present(e.pathname,!0),await e.remove()}else if("clipboard"==r)Pasteboard.copyString(s),o("Copied!","The output has been copied to the clipboard.");else if("file"==r){const e=await DocumentPicker.exportString(s,i);1==e.length?o("Saved to File","The output has been saved to the file:\n\n"+n(e[0])):e.length>1&&o("Saved to Multiple Files?","The output has been saved to the files?:\n\n"+e.map(n).join("\n"))}else rt();function o(e,t){const n=new Alert;n.title=e,n.message=t,n.addCancelAction("Okay"),n.presentAlert()}}async refreshDisabledEditionsServices(){const e=(e=>{if(He(e))return e;this.webcheckData.disabledEditionsData=void 0})(this.webcheckData.disabledEditionsData),t=await qe($t,"https://raw.githubusercontent.com/ChrisJohnsen/ISBN-Export-Tool/released/disabled-services",6048e5,e);this.webcheckData.disabledEditionsData=t;const n=t?.content;return n?new Set(n.split("\n").map((e=>e.trim())).filter((e=>st.has(e)))):new Set}activeServices;async requestEditionsServices(){const e=new Set(st);return(await this.refreshDisabledEditionsServices()).forEach((t=>e.delete(t))),this.disabledEditionsServices.forEach((t=>e.delete(t))),this.activeServices=e,Array.from(e)}abortingFetches=!1;editionsPromise;abortEditions;edtionsISBNs=new Set;async requestEditions(t,n){if(!this.selected)throw"requested editions before anything selected";if(!this.activeServices)throw"requested editions before services requested";if(this.testMode){const e=this.testMode?{title:"Warning: Test Mode Active",message:'External services for Get ISBNs "Other Editions" will not be contacted, fake data will be returned instead.',continue:"Continue in Test Mode",switch:"Switch to Normal Mode and Continue"}:{title:"Warning: Test Mode Inactive",message:'Actual requests will be made to external services for Get ISBNs of "Other Editions".',continue:"Continue in Normal Mode",switch:"Switch to Test Mode and Continue"},t=new Alert;t.title=e.title,t.message=e.message,t.addAction(e.continue),t.addAction(e.switch),t.addCancelAction("Do Not Run Get ISBNs");const n=await t.presentAlert();if(-1==n)throw"Aborted Get ISBNs after checking test mode";1==n&&(this.testMode=!this.testMode)}if(this.editionsPromise)throw console.error("requested a editions while it is already running"),"editions already running";const i=this.selected.isbns;this.abortingFetches=!1,this.editionsPromise=(async()=>{const a=(e=>t=>this.abortingFetches?Promise.reject(`aborting ${t}`):e(t))(this.testMode?Mt:Dt),o=new r(this.logPathnamer(this.testMode)),c=new s(this.cachePathnamer(this.testMode)),l={total:0,started:0,done:0,fetched:0},d=new Map,u=e=>{{const t=d.get(e);if(t)return t}const t={hits:0,queries:0,fetches:new Array};return d.set(e,t),t};await c.read();const h=(t=>{if(!t)return;if(e(t.data))return t.data;const n={};return t.data=n,n})(c),p=await Ze(i,{services:new Set(t.filter((e=>st.has(e))).filter((e=>this.activeServices?.has(e)))),cacheData:h,fetcher:a,reporter:e=>{if(this.abortingFetches)return;const t=e.event;if("abort fn"==t)this.abortEditions=e.fn;else if("rejection"==t)console.warn("GetISBNS Other Editions reported rejection"),console.error(e.reason);else if("service cache hit"==t)u(e.service).hits++;else if("query plan"==t)l.total=Array.from(e.plan.values()).reduce(((e,t)=>e+t.size),0);else if("service query started"==t){l.started++,n(l);const t=u(e.service);t.firstBegan||(t.firstBegan=Date.now()),t.queries++}else"fetch started"==t?console.log(`started ${e.url}`):"fetch finished"==t?(u(e.service).fetches.push(e.elapsed),l.fetched++,n(l)):"service query finished"==t&&(u(e.service).lastEnded=Date.now(),l.done++,n(l),e.warnings.forEach((e=>{console.warn(e.description),o.append(e.description)})),e.faults.forEach((e=>{console.warn(e.description),o.append(e.description)})))}});await c.write(),await o.flush();const f=e=>{e.sort(((e,t)=>e-t));const t=e.length%2==1?e[(e.length-1)/2]:(e[e.length/2-1]+e[e.length/2])/2;return{min:e[0],max:e[e.length-1],median:t}},g=Object.fromEntries(Array.from(d.entries()).map((([e,t])=>{const n=t.fetches.length/(((t.lastEnded??0)-(t.firstBegan??0))/1e3);return[e,{cacheHits:t.hits,queries:t.queries,fetches:t.fetches.length,fetchRate:n,fetchStats:f(t.fetches)}]})));return this.edtionsISBNs=p,{isbns:p.size,editionsServicesSummary:g}})();try{return await this.editionsPromise}finally{this.abortEditions=void 0,this.editionsPromise=void 0}}async requestCancelEditions(){return this.abortIfRunning()}async requestOutputEditionsISBNs(e,t){if(!this.selected)throw"requested output before anything selected";const n=`ISBNs of editions of ISBNs on ${this.selected.group.kind} ${this.selected.group.name}.txt`,i=e?et(this.edtionsISBNs):this.edtionsISBNs,s=Array.from(i).join("\n");return this.output(t,n,s)}async abortIfRunning(){this.abortingFetches=!0,this.abortEditions?.(),await this.editionsPromise}}((e=>e?Pt:Lt),(e=>e?Ut:jt),Wt.data.webcheckData,Ft),qt=new class{constructor(e,t){this.controller=e,this.savedDataObject=t,this.table.showSeparators=!0;const n=this.savedDataObject,i=n.group,s=n.services,r=n.both,a=n.editionsSlowOkay,o=n.editionsNetwork,c=n.updatesNetwork,l=n.firstRun;this.previous.group=i&&"object"==typeof i&&"kind"in i&&"string"==typeof i.kind&&"name"in i&&"string"==typeof i.name?i:void 0,this.previous.services=Array.isArray(s)?new Set(s.filter((e=>"string"==typeof e))):void 0,this.previous.both="boolean"==typeof r?r:void 0,this.previous.editionsSlowOkay=1==a||void 0,this.previous.editionsNetwork="boolean"==typeof o?o:void 0,this.previous.updatesNetwork="boolean"==typeof c?c:void 0,this.previous.firstRun="number"==typeof l?l:void 0,this.build()}table=new UITable;previous={};saveData(){this.savedDataObject.group=this.previous.group,this.savedDataObject.services=this.previous.services&&Array.from(this.previous.services),this.savedDataObject.both=this.previous.both,this.savedDataObject.editionsSlowOkay=this.previous.editionsSlowOkay,this.savedDataObject.editionsNetwork=this.previous.editionsNetwork,this.savedDataObject.updatesNetwork=this.previous.updatesNetwork,this.savedDataObject.firstRun=this.previous.firstRun}builder=new dt(this.table,"ISBN Export Tool");state=new wt(this.previous);async build(){this.table.removeAllRows();const e=e=>{this.state=e,this.build()},t=(t=>{if(!t.hideConfig)return()=>e(new ft(t,this.previous))})(this.state);this.builder.addTitleConfigRow(t).isHeader=!0;try{await this.state.build(this.builder,e,this.controller)}catch(e){console.error(e)}this.presented&&this.table.reload()}presented=!1;async present(...e){this.presented=!0;try{return await this.table.present(...e)}finally{this.presented=!1,this.saveData()}}}(Ht,Wt.data.UITableUIData);await qt.present(!0),await Ht.abortIfRunning(),await Ft();
